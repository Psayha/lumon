# üß™ A/B Testing System

–°–∏—Å—Ç–µ–º–∞ A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è Lumon Platform –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–º–∏ –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π.

## üìã –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑:
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** - —Ç–∞–±–ª–∏—Ü—ã `ab_experiments` –∏ `ab_assignments` –≤ PostgreSQL
- **n8n Workflows** - API endpoints –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–º–∏
- **Admin Panel** - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–º–∏

## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `ab_experiments`

–•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞—Ö:

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `id` | UUID | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ |
| `name` | VARCHAR(255) | –ù–∞–∑–≤–∞–Ω–∏–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ |
| `description` | TEXT | –û–ø–∏—Å–∞–Ω–∏–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ |
| `feature_name` | VARCHAR(255) | –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–π –ø—Ä–æ–≤–æ–¥–∏—Ç—Å—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç |
| `enabled` | BOOLEAN | –í–∫–ª—é—á–µ–Ω –ª–∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç |
| `traffic_percentage` | INTEGER | –ü—Ä–æ—Ü–µ–Ω—Ç —Ç—Ä–∞—Ñ–∏–∫–∞ (0-100) |
| `variant_a_config` | JSONB | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–∞—Ä–∏–∞–Ω—Ç–∞ A |
| `variant_b_config` | JSONB | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–∞—Ä–∏–∞–Ω—Ç–∞ B |
| `created_at` | TIMESTAMP | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |
| `updated_at` | TIMESTAMP | –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |

### –¢–∞–±–ª–∏—Ü–∞ `ab_assignments`

–•—Ä–∞–Ω–∏—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º:

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `id` | UUID | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è |
| `experiment_id` | UUID | ID —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ (FK) |
| `user_id` | VARCHAR(255) | ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `variant` | VARCHAR(1) | –í–∞—Ä–∏–∞–Ω—Ç ('A' –∏–ª–∏ 'B') |
| `assigned_at` | TIMESTAMP | –î–∞—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è |

**–ò–Ω–¥–µ–∫—Å—ã:**
- `idx_ab_assignments_experiment_id` - –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—É
- `idx_ab_assignments_user_id` - –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- `idx_ab_assignments_variant` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –≤–∞—Ä–∏–∞–Ω—Ç—É
- `idx_ab_experiments_feature_name` - –¥–ª—è –ø–æ–∏—Å–∫–∞ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ –ø–æ —Ñ—É–Ω–∫—Ü–∏–∏
- `idx_ab_experiments_enabled` - –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤

**–¢—Ä–∏–≥–≥–µ—Ä—ã:**
- `update_ab_experiments_updated_at` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç `updated_at` –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏

## üîå API Endpoints

### GET `/webhook/admin-ab-experiments-list`

–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤.

**–ó–∞–≥–æ–ª–æ–≤–∫–∏:**
```
Authorization: Bearer <admin_token>
```

**–û—Ç–≤–µ—Ç (—É—Å–ø–µ—Ö):**
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "name": "–ù–æ–≤—ã–π –¥–∏–∑–∞–π–Ω –∫–Ω–æ–ø–∫–∏",
      "description": "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞ –∫–Ω–æ–ø–∫–∏ –ø–æ–∫—É–ø–∫–∏",
      "featureName": "purchase_button",
      "enabled": true,
      "trafficPercentage": 50,
      "variantAConfig": {
        "color": "blue",
        "size": "large"
      },
      "variantBConfig": {
        "color": "green",
        "size": "medium"
      },
      "createdAt": "2024-01-01T00:00:00Z",
      "updatedAt": "2024-01-01T00:00:00Z",
      "variantAUsers": 150,
      "variantBUsers": 145
    }
  ],
  "traceId": "uuid"
}
```

**–û—Ç–≤–µ—Ç (–æ—à–∏–±–∫–∞):**
```json
{
  "error": "database_error",
  "status": 500,
  "message": "–û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏"
}
```

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

–¢–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –∏–ª–∏ –≤—Ä—É—á–Ω—É—é:

**–ß–µ—Ä–µ–∑ Docker (–µ—Å–ª–∏ PostgreSQL –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ):**
```bash
docker exec -i lumon-supabase-db psql -U postgres -d lumon < back/n8n/workflows/create-ab-tables-safe.sql
```

**–ò–ª–∏ —á–µ—Ä–µ–∑ SQL —Å–∫—Ä–∏–ø—Ç:**
```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
cd /var/www/lumon2
docker exec -i lumon-supabase-db psql -U postgres -d lumon << 'EOF'
# SQL –∏–∑ create-ab-tables-safe.sql
EOF
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü:**
```bash
docker exec -i lumon-supabase-db psql -U postgres -d lumon -c \
  "SELECT table_name FROM information_schema.tables WHERE table_name IN ('ab_experiments', 'ab_assignments');"
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ n8n Workflow

Workflow `admin.ab-experiments-list.json` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:
- –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ n8n
- –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω (Active = true)
- –ù–∞—Å—Ç—Ä–æ–µ–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ credentials PostgreSQL

**Credentials:**
- Host: `supabase-db` (–∏–ª–∏ –∏–º—è –≤–∞—à–µ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
- Database: `lumon`
- User: `postgres`
- Password: (–∏–∑ .env)

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

```bash
curl -X GET https://n8n.psayha.ru/webhook/admin-ab-experiments-list \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"
```

## üìù –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞

1. –û—Ç–∫—Ä–æ–π—Ç–µ Admin Panel ‚Üí AB Testing
2. –ù–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç"
3. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ:
   - –ù–∞–∑–≤–∞–Ω–∏–µ
   - –û–ø–∏—Å–∞–Ω–∏–µ
   - –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏
   - –ü—Ä–æ—Ü–µ–Ω—Ç —Ç—Ä–∞—Ñ–∏–∫–∞
   - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ A –∏ B
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

### –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

–í —Å–ø–∏—Å–∫–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –≤–∞—Ä–∏–∞–Ω—Ç–µ A
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –≤–∞—Ä–∏–∞–Ω—Ç–µ B
- –°—Ç–∞—Ç—É—Å (–≤–∫–ª—é—á–µ–Ω/–≤—ã–∫–ª—é—á–µ–Ω)
- –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

## üîß –ú–∏–≥—Ä–∞—Ü–∏–∏ –∏ —Å–∫—Ä–∏–ø—Ç—ã

### –°–∫—Ä–∏–ø—Ç—ã –≤ `back/n8n/workflows/`:

- **`create-ab-tables-safe.sql`** - –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ)
- **`create-ab-tables.sql`** - —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü —Å `IF NOT EXISTS`
- **`check-tables.sql`** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü
- **`verify-tables.sql`** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ –¥–∞–Ω–Ω—ã—Ö
- **`create-tables-all-dbs.sh`** - —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –≤–æ –≤—Å–µ—Ö PostgreSQL –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö
- **`run-migration.sh`** - —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
- **`run-migration.py`** - Python —Å–∫—Ä–∏–ø—Ç –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏

### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

```bash
# –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
docker exec -i lumon-supabase-db psql -U postgres -d lumon < back/n8n/workflows/create-ab-tables-safe.sql

# –ò–ª–∏ —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç
./back/n8n/workflows/run-migration.sh
```

## üêõ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

Workflow –≤–∫–ª—é—á–∞–µ—Ç —É–ª—É—á—à–µ–Ω–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫:

- **–û—à–∏–±–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö** - –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–æ–¥–∞–º–∏ PostgreSQL
- **–û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏** - –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
- **–û—à–∏–±–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è** - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –ë–î

**–§–æ—Ä–º–∞—Ç –æ—à–∏–±–æ–∫:**
```json
{
  "error": "database_error",
  "status": 500,
  "message": "Code: 42P01 | relation \"ab_experiments\" does not exist"
}
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–î–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

1. **Admin Panel** - –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
2. **API Endpoints** - –ø—Ä–æ–≥—Ä–∞–º–º–Ω—ã–π –¥–æ—Å—Ç—É–ø
3. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** - –ø—Ä—è–º—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã

**–ü—Ä–∏–º–µ—Ä SQL –∑–∞–ø—Ä–æ—Å–∞:**
```sql
SELECT 
    e.name,
    e.enabled,
    COUNT(DISTINCT a.user_id) FILTER (WHERE a.variant = 'A') as variant_a_users,
    COUNT(DISTINCT a.user_id) FILTER (WHERE a.variant = 'B') as variant_b_users
FROM ab_experiments e
LEFT JOIN ab_assignments a ON e.id = a.experiment_id
GROUP BY e.id, e.name, e.enabled;
```

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –í—Å–µ admin endpoints —Ç—Ä–µ–±—É—é—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞ —á–µ—Ä–µ–∑ `admin-validate` workflow
- –¢–∞–±–ª–∏—Ü—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –≤–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏ –¥–ª—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π

## üìö –°–≤—è–∑–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [Admin Panel Documentation](../adminpage/README.md)
- [Backend Documentation](../back/README.md)
- [Auth System](./AUTH_SYSTEM.md)

