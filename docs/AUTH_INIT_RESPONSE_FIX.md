# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: auth.init –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–µ —Ç–µ–ª–æ –æ—Ç–≤–µ—Ç–∞

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram WebApp:
- auth-init –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **200 OK** ‚úÖ
- –ù–æ —Ç–µ–ª–æ –æ—Ç–≤–µ—Ç–∞ **"[Unable to read response body]"** ‚ùå
- Token –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage
- –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø–∏—à–µ—Ç "–Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω"

### –õ–æ–≥–∏
```
[22:22:22] INFO : [FETCH] POST https://n8n.psayha.ru/webhook/auth-init-v2 ‚Üí 200 (340ms) {
  "status": 200,
  "statusText": "OK",
  "body": "[Unable to read response body]"  // ‚ùå –ü—É—Å—Ç–æ–µ —Ç–µ–ª–æ!
}
```

---

## –ü—Ä–∏—á–∏–Ω–∞

–í workflow `auth.init.v3.json` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:

```json
{
  "parameters": {
    "respondWith": "json",           // ‚ùå n8n –∏–Ω–æ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–µ —Ç–µ–ª–æ
    "responseBody": "={{ $json }}"   // ‚ùå –ù–µ —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
  }
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–≥–¥–∞ –≤ n8n –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `respondWith: "json"` —Å `responseBody: "={{ $json }}"`, n8n –Ω–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç –æ–±—ä–µ–∫—Ç, –∏ –∫–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –ø—É—Å—Ç–æ–µ —Ç–µ–ª–æ –æ—Ç–≤–µ—Ç–∞ –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON.

---

## –†–µ—à–µ–Ω–∏–µ ‚úÖ

–ò–∑–º–µ–Ω–∏–ª —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –Ω–∞ **text** —Å —Ä—É—á–Ω–æ–π —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π:

```json
{
  "parameters": {
    "respondWith": "text",                    // ‚úÖ –¢–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç
    "responseBody": "={{ JSON.stringify($json) }}", // ‚úÖ –Ø–≤–Ω–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è
    "options": {
      "responseHeaders": {
        "entries": [
          {
            "name": "Content-Type",
            "value": "application/json"       // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π Content-Type
          }
        ]
      }
    }
  }
}
```

### –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –î–æ | –ü–æ—Å–ª–µ |
|----------|-----|--------|
| **respondWith** | `"json"` | `"text"` |
| **responseBody** | `"={{ $json }}"` | `"={{ JSON.stringify($json) }}"` |
| **Content-Type** | `application/json` (–∞–≤—Ç–æ) | `application/json` (—è–≤–Ω–æ) |

---

## –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü–µ—Ä–µ–∏–º–ø–æ—Ä—Ç workflow (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è) ‚≠ê

1. **–û—Ç–∫—Ä–æ–π—Ç–µ n8n UI:** https://n8n.psayha.ru

2. **–î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ —Å—Ç–∞—Ä—ã–π workflow:**
   ```
   Workflows ‚Üí auth.init ‚Üí –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å (toggle off)
   ```

3. **–£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–π workflow (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**
   ```
   Workflows ‚Üí auth.init ‚Üí Delete
   ```

4. **–ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π:**
   ```
   Workflows ‚Üí Import from File
   ‚Üí –í—ã–±–µ—Ä–∏—Ç–µ: back/n8n/workflows/auth.init.v3.json
   ‚Üí –ù–∞—Å—Ç—Ä–æ–π—Ç–µ PostgreSQL credentials:
     - "Supabase PostgreSQL" –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –Ω–æ–¥
     - "Postgres account" –¥–ª—è Log Audit Event –Ω–æ–¥—ã
   ‚Üí –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ workflow (toggle on)
   ```

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: –†—É—á–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

–ï—Å–ª–∏ –Ω–µ —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å:

1. **–û—Ç–∫—Ä–æ–π—Ç–µ workflow "auth.init" –≤ n8n UI**

2. **–ù–∞–π–¥–∏—Ç–µ –Ω–æ–¥—É "Respond to Webhook":**
   ```
   –ù–æ–¥–∞ –≤ –∫–æ–Ω—Ü–µ workflow ‚Üí –∫–ª–∏–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   ```

3. **–ò–∑–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
   - **Respond With:** –∏–∑–º–µ–Ω–∏—Ç–µ —Å "JSON" –Ω–∞ **"Text"**
   - **Response Body:** –∏–∑–º–µ–Ω–∏—Ç–µ —Å `{{ $json }}` –Ω–∞ `{{ JSON.stringify($json) }}`
   - **Headers:** —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ `Content-Type: application/json`

4. **–ù–∞–π–¥–∏—Ç–µ –Ω–æ–¥—É "Respond Error":**
   ```
   –ù–æ–¥–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ ‚Üí –∫–ª–∏–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   ```

5. **–ò–∑–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ):**
   - **Respond With:** `"Text"`
   - **Response Body:** `{{ JSON.stringify($json) }}`
   - **Headers:** `Content-Type: application/json`

6. **–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ workflow**

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

### 1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram

```
1. –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ Mini App
3. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≥—Ä—É–∑–∫–∏
```

### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ DevTools (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
[FETCH] POST https://n8n.psayha.ru/webhook/auth-init-v2 ‚Üí 200 (300-500ms)
{
  "status": 200,
  "body": {
    "success": true,
    "data": {
      "session_token": "uuid-token-here",
      "user": {
        "id": "uuid",
        "role": "viewer",
        "company_id": null
      },
      "expires_at": "2025-11-17T..."
    }
  }
}
```

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ localStorage

–í –±—Ä–∞—É–∑–µ—Ä–Ω—ã—Ö DevTools:
```javascript
localStorage.getItem('session_token')
// –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å: "uuid-token-here"
```

### 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ë–ï–ó –æ—à–∏–±–∫–∏ "–Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω"
- ‚úÖ –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ —á–∞—Ç—ã
- ‚úÖ –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ 401 –≤ API –∑–∞–ø—Ä–æ—Å–∞—Ö

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ n8n Executions

1. **–û—Ç–∫—Ä–æ–π—Ç–µ:** https://n8n.psayha.ru/executions

2. **–ù–∞–π–¥–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ "auth.init"**

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–æ–¥—É "Respond to Webhook":**
   ```
   –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–µ–ª–µ–Ω–∞—è (—É—Å–ø–µ—à–Ω–∞—è)

   Output –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
   {
     "success": true,
     "data": {
       "session_token": "...",
       "user": {...},
       "expires_at": "..."
     }
   }
   ```

4. **–ï—Å–ª–∏ –æ—à–∏–±–∫–∞:**
   - –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ failed –Ω–æ–¥—É
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
   - –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ PostgreSQL credentials –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã

---

## –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
‚ùå auth-init ‚Üí 200 OK with empty body
‚ùå [Unable to read response body]
‚ùå Token –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
‚ùå "–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è" –Ω–∞ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö
‚ùå Chat list 401 error
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
‚úÖ auth-init ‚Üí 200 OK with valid JSON
‚úÖ Body —Å–æ–¥–µ—Ä–∂–∏—Ç session_token
‚úÖ Token —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage
‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
‚úÖ Chat list —Ä–∞–±–æ—Ç–∞–µ—Ç
‚úÖ –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
```

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

### –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ workflow –∞–∫—Ç–∏–≤–µ–Ω:**
   ```
   n8n UI ‚Üí Workflows ‚Üí auth.init ‚Üí toggle –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–µ–ª–µ–Ω—ã–º
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook path:**
   ```
   Webhook Trigger –Ω–æ–¥–∞ ‚Üí Path –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å: "auth-init-v2"
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ PostgreSQL credentials:**
   ```
   –í—Å–µ –Ω–æ–¥—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ credentials
   ```

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –±–∞–∑–µ:**
   ```sql
   SELECT * FROM sessions ORDER BY created_at DESC LIMIT 5;
   SELECT * FROM users ORDER BY last_login_at DESC LIMIT 5;
   ```

5. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ n8n:**
   ```bash
   docker logs <n8n-container-id> --tail 100
   ```

---

## –ü–æ—á–µ–º—É `text` –ª—É—á—à–µ —á–µ–º `json`?

| –ê—Å–ø–µ–∫—Ç | `respondWith: "json"` | `respondWith: "text"` |
|--------|------------------------|------------------------|
| **–°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è** | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è (–Ω–µ–Ω–∞–¥–µ–∂–Ω–∞—è) | –Ø–≤–Ω–∞—è —á–µ—Ä–µ–∑ JSON.stringify() |
| **–ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å** | ‚ùå –ú–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –ø—É—Å—Ç–æ–µ —Ç–µ–ª–æ | ‚úÖ –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É |
| **–û—Ç–ª–∞–¥–∫–∞** | ‚ùå –°–ª–æ–∂–Ω–æ –ø–æ–Ω—è—Ç—å —á—Ç–æ –Ω–µ —Ç–∞–∫ | ‚úÖ –í–∏–¥–Ω–æ —Ç–æ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç |
| **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** | ‚ùå –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–µ—Ä—Å–∏–∏ n8n | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –≤–µ–∑–¥–µ |
| **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** | ‚ùå –ò–Ω–æ–≥–¥–∞ –ø–∞–¥–∞–µ—Ç | ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–æ |

---

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–≠—Ç–æ –∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ –∫ –¥—Ä—É–≥–∏–º workflows:
- ‚úÖ `chat.create.v2.json` - HTTP Request responseFormat
- ‚úÖ `auth.set-viewer-role.json` - HTTP Request responseFormat
- ‚úÖ `analytics.json` - Simplified rate check

–°–º. —Ç–∞–∫–∂–µ:
- `docs/HTTP_REQUEST_RESPONSE_FORMAT_FIX.md` - –î–µ—Ç–∞–ª–∏ –ø–æ HTTP Request
- `docs/WORKFLOW_ERRORS_FIX.md` - –û–±—â–∏–µ –æ—à–∏–±–∫–∏ workflows

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –±—É–¥—É—â–∏—Ö workflows

### ‚úÖ –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏:

1. **–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `respondWith: "text"`** –¥–ª—è Respond to Webhook
2. **–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `JSON.stringify($json)`** –¥–ª—è body
3. **–Ø–≤–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ `Content-Type: application/json`** –≤ headers
4. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ response body** —á–µ—Ä–µ–∑ curl –∏–ª–∏ Postman
5. **–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ executions** –≤ n8n UI –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### ‚ùå –ò–∑–±–µ–≥–∞–π—Ç–µ:

1. `respondWith: "json"` —Å `responseBody: "={{ $json }}"` (–Ω–µ–Ω–∞–¥–µ–∂–Ω–æ)
2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ n8n
3. –ü—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–π –æ —Ñ–æ—Ä–º–∞—Ç–µ –æ—Ç–≤–µ—Ç–∞ –±–µ–∑ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
4. –û—Ç—Å—É—Ç—Å—Ç–≤–∏—è Content-Type headers

---

## –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –î–∞—Ç–∞ | –ö–æ–º–º–∏—Ç | –ò–∑–º–µ–Ω–µ–Ω–∏–µ |
|------|--------|-----------|
| 2025-11-10 | `e1f67f2` | Fix: auth.init responseFormat json ‚Üí text |

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-11-10
**–ö–æ–º–º–∏—Ç:** `e1f67f2`
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ –∫ –∏–º–ø–æ—Ä—Ç—É
