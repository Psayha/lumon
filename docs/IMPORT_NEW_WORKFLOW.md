# üöÄ –ò–º–ø–æ—Ä—Ç –Ω–æ–≤–æ–≥–æ —É–ø—Ä–æ—â–µ–Ω–Ω–æ–≥–æ chat.create workflow

## üì¶ –§–∞–π–ª –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
`back/n8n/workflows/chat.create.v2.json`

---

## ‚úÖ –ß—Ç–æ —É–ª—É—á—à–µ–Ω–æ –≤ –Ω–æ–≤–æ–º workflow

### 1. **–£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –¢–û–õ–¨–ö–û Authorization header
- –ù–µ—Ç —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏ —Å fallback –Ω–∞ body/query
- –ü–æ–Ω—è—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏

### 2. **–Ø–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ auth —É—Å–ø–µ—Ö–∞**
- IF —É–∑–µ–ª –ø–æ—Å–ª–µ Parse Auth Response
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `success === true`
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –∫–∞–∂–¥–æ–º –ø—É—Ç–∏

### 3. **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤**
- –í—Å–µ Respond nodes –∏—Å–ø–æ–ª—å–∑—É—é—Ç `respondWith: "json"`
- –ù–∏–∫–∞–∫–∏—Ö –ø—É—Å—Ç—ã—Ö `{}` –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

### 4. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ—Ç–æ–∫–∞**
```
Webhook Trigger
  ‚Üì
Extract Token (–∏–∑ Authorization header)
  ‚Üì
IF Token Error? ‚Üí Yes ‚Üí Respond Token Error
  ‚Üì No
Call auth.validate
  ‚Üì
Parse Auth Response
  ‚Üì
IF Auth Success? ‚Üí No ‚Üí Respond Auth Error
  ‚Üì Yes
Prepare Chat Data
  ‚Üì
Create Chat (INSERT –≤ –ë–î)
  ‚Üì
Build Response
  ‚Üì
Respond Success (201)
```

---

## üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏–º–ø–æ—Ä—Ç—É

### –®–∞–≥ 1: –≠–∫—Å–ø–æ—Ä—Ç —Å—Ç–∞—Ä–æ–≥–æ workflow (backup)

1. –û—Ç–∫—Ä–æ–π—Ç–µ https://n8n.psayha.ru
2. –ù–∞–π–¥–∏—Ç–µ workflow **`chat.create`**
3. –ù–∞–∂–º–∏—Ç–µ **‚ãÆ** (—Ç—Ä–∏ —Ç–æ—á–∫–∏) ‚Üí **Download**
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–∞–π–ª –∫–∞–∫ `chat.create.old.json`

### –®–∞–≥ 2: –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è —Å—Ç–∞—Ä–æ–≥–æ workflow

1. –û—Ç–∫—Ä–æ–π—Ç–µ workflow **`chat.create`**
2. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ **Active** –≤ **Inactive** (–≤—ã–∫–ª—é—á–∏—Ç–µ)
3. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

### –®–∞–≥ 3: –ò–º–ø–æ—Ä—Ç –Ω–æ–≤–æ–≥–æ workflow

1. –í n8n –Ω–∞–∂–º–∏—Ç–µ **+ Add workflow** (–≤–≤–µ—Ä—Ö—É —Å–ø—Ä–∞–≤–∞)
2. –ù–∞–∂–º–∏—Ç–µ **‚ãÆ** ‚Üí **Import from File**
3. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª: `back/n8n/workflows/chat.create.v2.json`
4. Workflow –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º `chat.create.v2`

### –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ credentials

**–í –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º workflow –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —É–∑–µ–ª "Create Chat":**

1. –û—Ç–∫—Ä–æ–π—Ç–µ —É–∑–µ–ª **"Create Chat"** (PostgreSQL)
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—ã–±—Ä–∞–Ω credential: **"Supabase PostgreSQL"**
3. –ï—Å–ª–∏ credential –Ω–µ –≤—ã–±—Ä–∞–Ω:
   - –ù–∞–∂–º–∏—Ç–µ **Select Credential**
   - –í—ã–±–µ—Ä–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π
   - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:
     ```
     Host: supabase-db (–∏–ª–∏ localhost –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
     Database: lumon
     User: postgres
     Password: (–∏–∑ .env —Ñ–∞–π–ª–∞)
     Port: 5432
     ```

### –®–∞–≥ 5: –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ workflow

1. –û—Ç–∫—Ä–æ–π—Ç–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π workflow `chat.create.v2`
2. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–≤–µ—Ä—Ö—É
3. –ü–µ—Ä–µ–∏–º–µ–Ω—É–π—Ç–µ –≤ **`chat.create`**
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

### –®–∞–≥ 6: –ê–∫—Ç–∏–≤–∞—Ü–∏—è

1. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ **Inactive** ‚Üí **Active**
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ webhook path = `chat-create`
3. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

### –®–∞–≥ 7: –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ workflow (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

1. –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ —Å—Ç–∞—Ä—ã–π workflow (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω)
2. –ù–∞–∂–º–∏—Ç–µ **‚ãÆ** ‚Üí **Delete**
3. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ß–µ—Ä–µ–∑ ApiTestPage

1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí **ApiTestPage** (`/api-test`)
2. –í—ã–±–µ—Ä–∏—Ç–µ endpoint: **chat-create**
3. –ù–∞–∂–º–∏—Ç–µ **Load Test Data**
4. –ù–∞–∂–º–∏—Ç–µ **Test Endpoint**

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "user_id": "uuid",
    "company_id": "uuid",
    "title": "Test Chat",
    "created_at": "2025-11-10T...",
    "updated_at": "2025-11-10T..."
  },
  "traceId": "uuid"
}
```

### –ß–µ—Ä–µ–∑ VoiceAssistantPage

1. –û—Ç–∫—Ä–æ–π—Ç–µ **VoiceAssistantPage**
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
3. –ß–∞—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –∞–¥–º–∏–Ω–∫–µ ‚Üí –õ–æ–≥–∏

---

## ‚ùå –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫

### –û—à–∏–±–∫–∞: "Credential not found"
**–†–µ—à–µ–Ω–∏–µ:** –í —É–∑–ª–µ "Create Chat" –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π PostgreSQL credential

### –û—à–∏–±–∫–∞: "Invalid or expired token"
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ workflow `auth.validate.v3` –∞–∫—Ç–∏–≤–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –û—à–∏–±–∫–∞: "User ID not found"
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç `auth.validate`:
- –î–æ–ª–∂–µ–Ω –±—ã—Ç—å: `data.user.id`
- –û—Ç–∫—Ä–æ–π—Ç–µ n8n Executions –∏ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç auth.validate

---

## üìä –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–æ–≤

### –£—Å–ø–µ—Ö (201):
```json
{
  "success": true,
  "data": {
    "id": "chat-uuid",
    "user_id": "user-uuid",
    "company_id": "company-uuid",
    "title": "Chat Title",
    "created_at": "2025-11-10T...",
    "updated_at": "2025-11-10T..."
  },
  "traceId": "trace-uuid"
}
```

### –û—à–∏–±–∫–∞: Missing token (401):
```json
{
  "success": false,
  "error": "unauthorized",
  "status": 401,
  "message": "Missing or invalid Authorization header"
}
```

### –û—à–∏–±–∫–∞: Invalid token (401):
```json
{
  "success": false,
  "error": "unauthorized",
  "status": 401,
  "message": "Invalid or expired token"
}
```

---

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–≥–æ workflow

‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞** ‚Äî –º–µ–Ω—å—à–µ —É–∑–ª–æ–≤, –ø–æ–Ω—è—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞
‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ
‚úÖ **–û—Ç–ª–∞–¥–∫–∞** ‚Äî –ª–µ–≥–∫–æ –Ω–∞–π—Ç–∏ –≥–¥–µ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞
‚úÖ **–û—à–∏–±–∫–∏** ‚Äî –≤—Å–µ–≥–¥–∞ –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–∏–∫–∞–∫–∏—Ö –ø—É—Å—Ç—ã—Ö `{}`
‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** ‚Äî –Ω–µ—Ç –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ –∏ fallback –ª–æ–≥–∏–∫–∏

---

## üìù –ß—Ç–æ –¥–∞–ª—å—à–µ?

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
1. –ú–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π workflow
2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç—É –∂–µ –ª–æ–≥–∏–∫—É –∫ –¥—Ä—É–≥–∏–º workflows (save-message, get-chat-history)
3. –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω
