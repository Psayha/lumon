---
globs: front/**/*.tsx,packages/**/*.tsx
description: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram —Ñ—É–Ω–∫—Ü–∏–π
---

# üß™ Telegram Testing

## üéØ –ü—Ä–∏–Ω—Ü–∏–ø—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Telegram Mini Apps

### ‚úÖ –°–¢–†–ê–¢–ï–ì–ò–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø
- Unit —Ç–µ—Å—Ç—ã –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- Integration —Ç–µ—Å—Ç—ã –¥–ª—è Telegram API
- E2E —Ç–µ—Å—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- Mock –æ–±—ä–µ–∫—Ç—ã –¥–ª—è Telegram WebApp

### ‚úÖ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ö–û–ú–ü–û–ù–ï–ù–¢–û–í
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –∫ —Ç–µ–º–∞–º
- –ü—Ä–æ–≤–µ—Ä–∫–∞ haptic feedback
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–æ—Ä–º

### ‚úÖ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï API
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram WebApp API
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Bot API

## üìù –ü–†–ò–ú–ï–†–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø

### ‚úÖ Unit —Ç–µ—Å—Ç—ã –¥–ª—è Telegram –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
```tsx
// TelegramButton.test.tsx
import React from 'react';
import { render, fireEvent, screen } from '@testing-library/react';
import { TelegramButton } from '../TelegramButton';

// Mock –¥–ª—è useTelegramTheme
jest.mock('../hooks/useTelegramTheme', () => ({
  useTelegramTheme: () => ({
    themeParams: {
      button_color: '#2481cc',
      button_text_color: '#ffffff'
    }
  })
}));

describe('TelegramButton', () => {
  it('renders with correct text', () => {
    render(<TelegramButton>Click me</TelegramButton>);
    expect(screen.getByText('Click me')).toBeInTheDocument();
  });

  it('calls onClick when clicked', () => {
    const handleClick = jest.fn();
    render(<TelegramButton onClick={handleClick}>Click me</TelegramButton>);
    
    fireEvent.click(screen.getByText('Click me'));
    expect(handleClick).toHaveBeenCalledTimes(1);
  });

  it('shows loading state', () => {
    render(<TelegramButton loading={true}>Click me</TelegramButton>);
    expect(screen.getByRole('button')).toBeDisabled();
  });

  it('applies correct styles based on variant', () => {
    const { rerender } = render(<TelegramButton variant="primary">Primary</TelegramButton>);
    expect(screen.getByRole('button')).toHaveStyle({
      backgroundColor: '#2481cc',
      color: '#ffffff'
    });

    rerender(<TelegramButton variant="secondary">Secondary</TelegramButton>);
    expect(screen.getByRole('button')).toHaveStyle({
      backgroundColor: '#f1f1f1',
      color: '#000000'
    });
  });
});
```

### ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram —Ö—É–∫–æ–≤
```tsx
// useTelegram.test.ts
import { renderHook } from '@testing-library/react';
import { useTelegram } from '../useTelegram';

// Mock –¥–ª—è window.Telegram
const mockTelegramWebApp = {
  ready: jest.fn(),
  close: jest.fn(),
  BackButton: {
    show: jest.fn(),
    hide: jest.fn(),
    onClick: jest.fn()
  },
  MainButton: {
    show: jest.fn(),
    hide: jest.fn(),
    setText: jest.fn(),
    onClick: jest.fn()
  },
  HapticFeedback: {
    impactOccurred: jest.fn()
  }
};

describe('useTelegram', () => {
  beforeEach(() => {
    // –û—á–∏—â–∞–µ–º –º–æ–∫–∏
    jest.clearAllMocks();
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º mock –¥–ª—è window.Telegram
    (window as any).Telegram = {
      WebApp: mockTelegramWebApp
    };
  });

  afterEach(() => {
    // –û—á–∏—â–∞–µ–º window.Telegram
    delete (window as any).Telegram;
  });

  it('returns telegram instance when available', () => {
    const { result } = renderHook(() => useTelegram());
    
    expect(result.current.tg).toBe(mockTelegramWebApp);
    expect(result.current.isReady).toBe(true);
  });

  it('returns null when telegram is not available', () => {
    delete (window as any).Telegram;
    
    const { result } = renderHook(() => useTelegram());
    
    expect(result.current.tg).toBeNull();
    expect(result.current.isReady).toBe(false);
  });

  it('calls ready() when telegram is available', () => {
    renderHook(() => useTelegram());
    
    expect(mockTelegramWebApp.ready).toHaveBeenCalledTimes(1);
  });
});
```

### ‚úÖ Integration —Ç–µ—Å—Ç—ã –¥–ª—è Telegram API
```tsx
// TelegramAPI.test.ts
import { TelegramAPI } from '../TelegramAPI';

// Mock –¥–ª—è fetch
global.fetch = jest.fn();

describe('TelegramAPI', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  describe('sendMessage', () => {
    it('sends message successfully', async () => {
      const mockResponse = { ok: true, json: () => Promise.resolve({ result: { message_id: 123 } }) };
      (fetch as jest.Mock).mockResolvedValue(mockResponse);

      const result = await TelegramAPI.sendMessage('123456', 'Hello World');

      expect(fetch).toHaveBeenCalledWith(
        'https://api.telegram.org/bot<TOKEN>/sendMessage',
        expect.objectContaining({
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chat_id: '123456',
            text: 'Hello World'
          })
        })
      );
      expect(result).toEqual({ message_id: 123 });
    });

    it('handles API errors', async () => {
      const mockResponse = { ok: false, status: 400, json: () => Promise.resolve({ error_code: 400, description: 'Bad Request' }) };
      (fetch as jest.Mock).mockResolvedValue(mockResponse);

      await expect(TelegramAPI.sendMessage('123456', 'Hello World')).rejects.toThrow('Bad Request');
    });
  });

  describe('getUserInfo', () => {
    it('returns user information', async () => {
      const mockUser = { id: 123, first_name: 'John', username: 'john_doe' };
      const mockResponse = { ok: true, json: () => Promise.resolve({ result: mockUser }) };
      (fetch as jest.Mock).mockResolvedValue(mockResponse);

      const result = await TelegramAPI.getUserInfo('123');

      expect(result).toEqual(mockUser);
    });
  });
});
```

### ‚úÖ E2E —Ç–µ—Å—Ç—ã –¥–ª—è Telegram Mini App
```tsx
// TMA.e2e.test.ts
import { test, expect } from '@playwright/test';

test.describe('Telegram Mini App', () => {
  test.beforeEach(async ({ page }) => {
    // Mock Telegram WebApp
    await page.addInitScript(() => {
      window.Telegram = {
        WebApp: {
          ready: () => {},
          close: () => {},
          initData: 'user=%7B%22id%22%3A123%2C%22first_name%22%3A%22John%22%7D',
          initDataUnsafe: {
            user: { id: 123, first_name: 'John' }
          },
          themeParams: {
            bg_color: '#ffffff',
            text_color: '#000000',
            button_color: '#2481cc'
          },
          BackButton: {
            show: () => {},
            hide: () => {},
            onClick: () => {}
          },
          MainButton: {
            show: () => {},
            hide: () => {},
            setText: () => {},
            onClick: () => {}
          },
          HapticFeedback: {
            impactOccurred: () => {}
          }
        }
      };
    });

    await page.goto('/');
  });

  test('displays welcome message with user name', async ({ page }) => {
    await expect(page.getByText('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, John!')).toBeVisible();
  });

  test('navigates to voice assistant page', async ({ page }) => {
    await page.click('text=üé§ –ì–æ–ª–æ—Å–æ–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç');
    await expect(page.getByText('–ì–æ–ª–æ—Å–æ–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç')).toBeVisible();
  });

  test('shows main button when required', async ({ page }) => {
    await page.click('text=‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏');
    await expect(page.getByRole('button', { name: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' })).toBeVisible();
  });

  test('handles form submission', async ({ page }) => {
    await page.click('text=–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å');
    
    await page.fill('input[placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è"]', 'John Doe');
    await page.fill('input[placeholder="your@email.com"]', 'john@example.com');
    await page.fill('textarea[placeholder*="–û–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å"]', 'Test message');
    
    await page.click('button:has-text("–û—Ç–ø—Ä–∞–≤–∏—Ç—å")');
    
    await expect(page.getByText('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ')).toBeVisible();
  });
});
```

### ‚úÖ Mock –æ–±—ä–µ–∫—Ç—ã –¥–ª—è Telegram
```tsx
// __mocks__/telegram.ts
export const mockTelegramWebApp = {
  ready: jest.fn(),
  close: jest.fn(),
  expand: jest.fn(),
  initData: 'user=%7B%22id%22%3A123%2C%22first_name%22%3A%22John%22%7D',
  initDataUnsafe: {
    user: {
      id: 123,
      first_name: 'John',
      last_name: 'Doe',
      username: 'john_doe',
      language_code: 'en'
    }
  },
  themeParams: {
    bg_color: '#ffffff',
    text_color: '#000000',
    hint_color: '#999999',
    link_color: '#2481cc',
    button_color: '#2481cc',
    button_text_color: '#ffffff',
    secondary_bg_color: '#f8f9fa'
  },
  colorScheme: 'light',
  BackButton: {
    show: jest.fn(),
    hide: jest.fn(),
    onClick: jest.fn()
  },
  MainButton: {
    show: jest.fn(),
    hide: jest.fn(),
    setText: jest.fn(),
    onClick: jest.fn(),
    showProgress: jest.fn(),
    hideProgress: jest.fn()
  },
  HapticFeedback: {
    impactOccurred: jest.fn(),
    notificationOccurred: jest.fn(),
    selectionChanged: jest.fn()
  },
  setHeaderColor: jest.fn(),
  setBackgroundColor: jest.fn()
};

// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º mock –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º scope
Object.defineProperty(window, 'Telegram', {
  value: { WebApp: mockTelegramWebApp },
  writable: true
});
```

### ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –∫ —Ç–µ–º–∞–º
```tsx
// ThemeAdaptation.test.tsx
import React from 'react';
import { render, screen } from '@testing-library/react';
import { TelegramCard } from '../TelegramCard';

// Mock –¥–ª—è useTelegramTheme
const mockUseTelegramTheme = jest.fn();

jest.mock('../hooks/useTelegramTheme', () => ({
  useTelegramTheme: () => mockUseTelegramTheme()
}));

describe('Theme Adaptation', () => {
  it('adapts to light theme', () => {
    mockUseTelegramTheme.mockReturnValue({
      themeParams: {
        bg_color: '#ffffff',
        text_color: '#000000',
        secondary_bg_color: '#f8f9fa'
      }
    });

    render(<TelegramCard>Test content</TelegramCard>);
    
    const card = screen.getByText('Test content').parentElement;
    expect(card).toHaveStyle({
      backgroundColor: '#f8f9fa'
    });
  });

  it('adapts to dark theme', () => {
    mockUseTelegramTheme.mockReturnValue({
      themeParams: {
        bg_color: '#1a1a1a',
        text_color: '#ffffff',
        secondary_bg_color: '#2a2a2a'
      }
    });

    render(<TelegramCard>Test content</TelegramCard>);
    
    const card = screen.getByText('Test content').parentElement;
    expect(card).toHaveStyle({
      backgroundColor: '#2a2a2a'
    });
  });
});
```

## üéØ –õ–£–ß–®–ò–ï –ü–†–ê–ö–¢–ò–ö–ò

### 1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ—Å—Ç—ã–µ mock –æ–±—ä–µ–∫—Ç—ã**
```tsx
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –ø—Ä–æ—Å—Ç—ã–µ –º–æ–∫–∏
const mockTelegram = {
  WebApp: {
    ready: jest.fn(),
    close: jest.fn()
  }
};
```

### 2. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏**
```tsx
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
test('user can complete onboarding flow', async ({ page }) => {
  await page.click('text=–ù–∞—á–∞—Ç—å');
  await page.fill('input[name="name"]', 'John');
  await page.click('text=–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å');
  await expect(page.getByText('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, John!')).toBeVisible();
});
```

### 3. **–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫**
```tsx
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
it('handles API errors gracefully', async () => {
  const mockError = new Error('API Error');
  jest.spyOn(TelegramAPI, 'sendMessage').mockRejectedValue(mockError);
  
  const { result } = renderHook(() => useTelegramAPI());
  
  await act(async () => {
    await result.current.sendMessage('Hello');
  });
  
  expect(result.current.error).toBe(mockError);
});
```

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û

### ‚ùå –ù–ï –î–ï–õ–ê–ô–¢–ï
```tsx
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - —Å–ª–æ–∂–Ω—ã–µ mock –æ–±—ä–µ–∫—Ç—ã
const complexMock = {
  WebApp: {
    // –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –º–µ—Ç–æ–¥–æ–≤
  }
};

// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
const BadComponent = () => {
  // –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤
};

// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
it('calls internal method', () => {
  // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ª–æ–≥–∏–∫–∏
});
```

### ‚úÖ –î–ï–õ–ê–ô–¢–ï –¢–ê–ö
```tsx
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –ø—Ä–æ—Å—Ç—ã–µ –º–æ–∫–∏
const simpleMock = {
  WebApp: { ready: jest.fn() }
};

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–≤–µ–¥–µ–Ω–∏—è
it('shows loading state', () => {
  render(<Component loading={true} />);
  expect(screen.getByText('Loading...')).toBeVisible();
});

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞
it('allows user to submit form', async () => {
  render(<Form />);
  await user.type(screen.getByLabelText('Name'), 'John');
  await user.click(screen.getByRole('button', { name: 'Submit' }));
  expect(screen.getByText('Success!')).toBeVisible();
});
```

---

**–ü–æ–º–Ω–∏**: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ TMA –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—Ä–æ—Å—Ç—ã–º –∏ —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º –æ–ø—ã—Ç–µ.