# Nginx health endpoint configuration
# Add this location block to your main nginx config (lumon-frontend)

location /health {
    access_log off;
    default_type application/json;
    
    # Simple health check - returns 200 if nginx is running
    return 200 '{"status":"ok","service":"nginx","timestamp":"$time_iso8601"}';
    
    add_header Content-Type application/json;
}

# Health check with backend services
location /health/full {
    access_log off;
    default_type application/json;
    
    # Proxy to n8n health-check endpoint (requires admin token)
    # For public access, use a simple version
    content_by_lua_block {
        local http = require "resty.http"
        local httpc = http.new()
        
        -- Check n8n
        local n8n_res, n8n_err = httpc:request_uri("http://127.0.0.1:5678/healthz", {
            method = "GET",
            timeout = 2000
        })
        
        -- Check PostgreSQL via Docker
        local pg_status = "unknown"
        local pg_res = os.execute("docker exec lumon-supabase-db pg_isready -U postgres > /dev/null 2>&1")
        if pg_res == 0 then
            pg_status = "healthy"
        else
            pg_status = "unhealthy"
        end
        
        -- Simple response
        local response = {
            status = "ok",
            timestamp = ngx.var.time_iso8601,
            services = {
                nginx = "healthy",
                n8n = (n8n_res and n8n_res.status == 200) and "healthy" or "unhealthy",
                postgresql = pg_status
            }
        }
        
        ngx.header.content_type = "application/json"
        ngx.say(require("cjson").encode(response))
    }
}

