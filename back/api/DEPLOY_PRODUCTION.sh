#!/bin/bash
# ğŸš€ Production Deployment Instructions
# Lumon NestJS API â†’ n8n.psayha.ru

set -e

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  ğŸ“‹ Lumon API Production Deployment Guide              â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo_step() {
    echo -e "${BLUE}â–¶${NC} $1"
}

echo_success() {
    echo -e "${GREEN}âœ“${NC} $1"
}

echo_warning() {
    echo -e "${YELLOW}âš ${NC} $1"
}

echo_error() {
    echo -e "${RED}âœ—${NC} $1"
}

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  STEP 1: Pre-deployment Checklist"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo_step "ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ .env:"
echo ""
echo "  1. Supabase Database:"
echo "     - DB_HOST (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: db.xxxxx.supabase.co)"
echo "     - DB_PASSWORD"
echo ""
echo "  2. OpenAI API Key:"
echo "     - ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ½Ğ°: https://platform.openai.com/api-keys"
echo ""
echo "  3. Telegram Bot Token:"
echo "     - ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ñƒ @BotFather"
echo ""
echo "  4. Admin Credentials:"
echo "     - ADMIN_USERNAME (Ğ½Ğ° Ğ²Ğ°Ñˆ Ğ²Ñ‹Ğ±Ğ¾Ñ€)"
echo "     - ADMIN_PASSWORD (Ğ½Ğ° Ğ²Ğ°Ñˆ Ğ²Ñ‹Ğ±Ğ¾Ñ€, Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 12 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²)"
echo ""

read -p "Ğ£ Ğ²Ğ°Ñ ĞµÑÑ‚ÑŒ Ğ²ÑÑ ÑÑ‚Ğ° Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ? (y/n): " has_info
if [ "$has_info" != "y" ]; then
    echo_warning "Ğ¡Ğ¾Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼ÑƒÑ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ ÑĞ½Ğ¾Ğ²Ğ°"
    exit 0
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  STEP 2: Navigate to API directory"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo_step "ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ API..."
cd /home/user/lumon/back/api
echo_success "Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ: $(pwd)"

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  STEP 3: Configure Environment"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

if [ -f ".env" ]; then
    echo_warning ".env Ñ„Ğ°Ğ¹Ğ» ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚"
    read -p "ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ? (y/n): " overwrite
    if [ "$overwrite" != "y" ]; then
        echo_step "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ .env Ñ„Ğ°Ğ¹Ğ»"
    else
        echo_step "Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ .env Ñ„Ğ°Ğ¹Ğ»..."
        cp .env.production.example .env
        echo_success ".env Ñ„Ğ°Ğ¹Ğ» ÑĞ¾Ğ·Ğ´Ğ°Ğ½"
    fi
else
    echo_step "Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ .env Ñ„Ğ°Ğ¹Ğ» Ğ¸Ğ· ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ°..."
    cp .env.production.example .env
    echo_success ".env Ñ„Ğ°Ğ¹Ğ» ÑĞ¾Ğ·Ğ´Ğ°Ğ½"
fi

echo ""
echo_warning "Ğ’ĞĞ–ĞĞ: ĞÑ‚Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ .env Ñ„Ğ°Ğ¹Ğ»!"
echo ""
echo "ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ .env Ğ² Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€Ğµ:"
echo "  nano .env"
echo ""
echo "Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ Ğ¿Ğ¾Ğ»Ñ:"
echo "  - DB_HOST=db.xxxxx.supabase.co"
echo "  - DB_PASSWORD=your-supabase-password"
echo "  - OPENAI_API_KEY=sk-..."
echo "  - TELEGRAM_BOT_TOKEN=123456:ABC..."
echo "  - ADMIN_USERNAME=admin"
echo "  - ADMIN_PASSWORD=secure_password"
echo ""

read -p "ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Enter Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€ .env..."
nano .env

echo ""
echo_step "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ .env Ñ„Ğ°Ğ¹Ğ»..."

# Check if required variables are set
if grep -q "DB_PASSWORD=your-supabase-password" .env || \
   grep -q "OPENAI_API_KEY=$" .env || \
   grep -q "TELEGRAM_BOT_TOKEN=$" .env; then
    echo_error "ĞĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ½Ğµ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ñ‹!"
    echo "ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ²ÑĞµ Ğ¿Ğ¾Ğ»Ñ Ğ² .env"
    exit 1
fi

echo_success ".env Ñ„Ğ°Ğ¹Ğ» Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½"

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  STEP 4: Install Dependencies & Build"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo_step "Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ (ÑÑ‚Ğ¾ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ·Ğ°Ğ½ÑÑ‚ÑŒ 1-2 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹)..."
npm ci --production

echo ""
echo_step "Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ..."
npm run build

if [ ! -d "dist" ]; then
    echo_error "Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ°ÑÑŒ!"
    exit 1
fi

echo_success "ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ğ¾"

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  STEP 5: Install Systemd Service"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo_step "Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ systemd service..."

if [ ! -f "/etc/systemd/system/lumon-api.service" ]; then
    sudo cp lumon-api.service /etc/systemd/system/
    sudo systemctl daemon-reload
    echo_success "Systemd service ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½"
else
    echo_warning "Systemd service ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚"
    read -p "ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ? (y/n): " update_service
    if [ "$update_service" = "y" ]; then
        sudo cp lumon-api.service /etc/systemd/system/
        sudo systemctl daemon-reload
        echo_success "Systemd service Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½"
    fi
fi

echo ""
echo_step "Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑĞµÑ€Ğ²Ğ¸Ñ..."
sudo systemctl enable lumon-api
sudo systemctl start lumon-api

sleep 2

if sudo systemctl is-active --quiet lumon-api; then
    echo_success "Lumon API ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½!"
else
    echo_error "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ ÑĞµÑ€Ğ²Ğ¸Ñ"
    echo "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ»Ğ¾Ğ³Ğ¸: sudo journalctl -u lumon-api -n 50"
    exit 1
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  STEP 6: Test API Locally"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo_step "Ğ¢ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ API Ğ½Ğ° localhost:3000..."

sleep 1

if curl -s http://localhost:3000/health > /dev/null 2>&1; then
    echo_success "Health check: OK"
    curl -s http://localhost:3000/health | python3 -m json.tool 2>/dev/null || curl -s http://localhost:3000/health
else
    echo_error "API Ğ½Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ Ğ½Ğ° localhost:3000"
    echo "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ»Ğ¾Ğ³Ğ¸: sudo journalctl -u lumon-api -f"
    exit 1
fi

echo ""
echo_step "Ğ¢ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ auth endpoint..."
curl -s -X POST http://localhost:3000/webhook/auth-init-v2 \
  -H "Content-Type: application/json" \
  -d '{"initData":"test"}' | head -c 200
echo ""
echo_success "Auth endpoint Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ (Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ğ°)"

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  STEP 7: Install & Configure Nginx"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Check if nginx is installed
if ! command -v nginx &> /dev/null; then
    echo_step "Nginx Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½. Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼..."
    sudo apt update
    sudo apt install -y nginx
    echo_success "Nginx ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½"
else
    echo_success "Nginx ÑƒĞ¶Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½"
fi

echo ""
echo_step "ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ nginx..."

sudo cp nginx-lumon-api.conf /etc/nginx/sites-available/lumon-api

if [ ! -L "/etc/nginx/sites-enabled/lumon-api" ]; then
    sudo ln -s /etc/nginx/sites-available/lumon-api /etc/nginx/sites-enabled/
    echo_success "Symlink ÑĞ¾Ğ·Ğ´Ğ°Ğ½"
else
    echo_warning "Symlink ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚"
fi

echo ""
echo_step "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ nginx..."
if sudo nginx -t; then
    echo_success "ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ nginx Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ°"
else
    echo_error "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ nginx!"
    exit 1
fi

echo ""
echo_step "ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ nginx..."
sudo systemctl reload nginx
echo_success "Nginx Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½"

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  STEP 8: Setup SSL Certificate"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo_warning "SSL ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚ Ğ½ÑƒĞ¶ĞµĞ½ Ğ´Ğ»Ñ production!"
echo ""
read -p "Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ SSL ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚ ÑĞµĞ¹Ñ‡Ğ°Ñ? (y/n): " install_ssl

if [ "$install_ssl" = "y" ]; then
    if ! command -v certbot &> /dev/null; then
        echo_step "Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ certbot..."
        sudo apt install -y certbot python3-certbot-nginx
    fi

    echo ""
    echo_step "ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ SSL ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚ Ğ´Ğ»Ñ n8n.psayha.ru..."
    echo_warning "Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ Ñ‡Ñ‚Ğ¾ DNS Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾!"

    sudo certbot --nginx -d n8n.psayha.ru

    echo_success "SSL ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½"
else
    echo_warning "SSL Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¶Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ¾Ğ¹:"
    echo "  sudo certbot --nginx -d n8n.psayha.ru"
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  STEP 9: Test API via Nginx"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo_step "Ğ¢ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ API Ñ‡ĞµÑ€ĞµĞ· nginx..."

# Determine protocol
if [ "$install_ssl" = "y" ]; then
    PROTO="https"
else
    PROTO="http"
fi

if curl -s ${PROTO}://n8n.psayha.ru/health > /dev/null 2>&1; then
    echo_success "API Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ñ‡ĞµÑ€ĞµĞ· ${PROTO}://n8n.psayha.ru/health"
    curl -s ${PROTO}://n8n.psayha.ru/health | python3 -m json.tool 2>/dev/null
else
    echo_warning "API Ğ½Ğµ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ñ‡ĞµÑ€ĞµĞ· nginx"
    echo "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ:"
    echo "  - DNS Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ´Ğ»Ñ n8n.psayha.ru"
    echo "  - Firewall (Ğ¿Ğ¾Ñ€Ñ‚Ñ‹ 80, 443)"
    echo "  - Nginx ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³: sudo nginx -t"
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  STEP 10: Update Frontend"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo_step "ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ frontend ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ..."

cd /home/user/lumon

if [ "$install_ssl" = "y" ]; then
    echo "VITE_API_URL=https://n8n.psayha.ru" > .env.production
    echo_success "Frontend Ğ±ÑƒĞ´ĞµÑ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ https://n8n.psayha.ru"
else
    echo "VITE_API_URL=http://n8n.psayha.ru" > .env.production
    echo_success "Frontend Ğ±ÑƒĞ´ĞµÑ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ http://n8n.psayha.ru"
fi

echo ""
read -p "ĞŸĞµÑ€ĞµÑĞ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ frontend ÑĞµĞ¹Ñ‡Ğ°Ñ? (y/n): " rebuild_frontend

if [ "$rebuild_frontend" = "y" ]; then
    echo_step "Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ frontend..."
    npm run build
    echo_success "Frontend Ğ¿ĞµÑ€ĞµÑĞ¾Ğ±Ñ€Ğ°Ğ½"
else
    echo_warning "ĞŸĞµÑ€ĞµÑĞ¾Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ frontend Ğ¿Ğ¾Ğ·Ğ¶Ğµ: npm run build"
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  âœ… DEPLOYMENT COMPLETE!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo_success "Lumon NestJS API ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ´ĞµĞ¿Ğ»Ğ¾ĞµĞ½!"
echo ""
echo "â•â•â• Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ² â•â•â•"
echo ""
sudo systemctl status lumon-api --no-pager | head -10
echo ""
echo "â•â•â• API Endpoints â•â•â•"
echo ""
if [ "$install_ssl" = "y" ]; then
    echo "  Health Check: https://n8n.psayha.ru/health"
    echo "  Auth Init:    https://n8n.psayha.ru/webhook/auth-init-v2"
    echo "  Admin Login:  https://n8n.psayha.ru/webhook/admin/login"
else
    echo "  Health Check: http://n8n.psayha.ru/health"
    echo "  Auth Init:    http://n8n.psayha.ru/webhook/auth-init-v2"
    echo "  Admin Login:  http://n8n.psayha.ru/webhook/admin/login"
fi
echo ""
echo "â•â•â• Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ â•â•â•"
echo ""
echo "  Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:     sudo systemctl status lumon-api"
echo "  ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº: sudo systemctl restart lumon-api"
echo "  Ğ›Ğ¾Ğ³Ğ¸:       sudo journalctl -u lumon-api -f"
echo "  ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ: sudo systemctl stop lumon-api"
echo ""
echo "â•â•â• Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑˆĞ°Ğ³Ğ¸ â•â•â•"
echo ""
echo "  1. ĞŸÑ€Ğ¾Ñ‚ĞµÑÑ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ API Ñ‡ĞµÑ€ĞµĞ· Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€:"
if [ "$install_ssl" = "y" ]; then
    echo "     https://n8n.psayha.ru/health"
else
    echo "     http://n8n.psayha.ru/health"
fi
echo ""
echo "  2. ĞŸÑ€Ğ¾Ñ‚ĞµÑÑ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ñ‡ĞµÑ€ĞµĞ· frontend:"
echo "     - Ğ—Ğ°Ğ»Ğ¾Ğ³Ğ¸Ğ½ÑŒÑ‚ĞµÑÑŒ Ñ‡ĞµÑ€ĞµĞ· Telegram"
echo "     - Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ñ‡Ğ°Ñ‚"
echo "     - ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ"
echo ""
echo "  3. ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€ÑŒÑ‚Ğµ Ğ»Ğ¾Ğ³Ğ¸ 24 Ñ‡Ğ°ÑĞ°:"
echo "     sudo journalctl -u lumon-api -f"
echo ""
echo "  4. ĞŸĞ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ³Ğ¾ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:"
echo "     - ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ n8n"
echo "     - Ğ˜Ğ»Ğ¸ Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ°Ğº backup Ğ½Ğ° n8n-backup.psayha.ru"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo_success "Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾! ğŸš€"
