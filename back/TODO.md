# ‚úÖ –ü–ª–∞–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ Backend

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

- [x] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker Compose (n8n + Supabase)
- [x] –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î (–º–∏–≥—Ä–∞—Ü–∏–∏)
- [x] –ó–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ n8n Workflows (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –í–´–°–û–ö–ò–ô)

**–¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å API endpoints —á–µ—Ä–µ–∑ n8n –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å frontend

#### 1.1. Workflow: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- **Endpoint:** `POST /webhook/save-message`
- **–î–µ–π—Å—Ç–≤–∏—è:**
  - –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ Webhook Trigger
  - –í–∞–ª–∏–¥–∞—Ü–∏—è (userId, chatId, message, role)
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—Ü—É `messages`
  - –í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

#### 1.2. Workflow: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
- **Endpoint:** `GET /webhook/get-chat-history`
- **–î–µ–π—Å—Ç–≤–∏—è:**
  - –ü–æ–ª—É—á–∏—Ç—å chatId –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
  - –ó–∞–ø—Ä–æ—Å –∫ PostgreSQL (SELECT messages WHERE chat_id)
  - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ created_at DESC
  - –í–æ–∑–≤—Ä–∞—Ç —Å–ø–∏—Å–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π

#### 1.3. Workflow: –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **Endpoint:** `POST /webhook/create-user`
- **–î–µ–π—Å—Ç–≤–∏—è:**
  - –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è (SELECT –ø–æ telegram_id)
  - –°–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ `users`
  - –í–æ–∑–≤—Ä–∞—Ç user data

#### 1.4. Workflow: –°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞
- **Endpoint:** `POST /webhook/create-chat`
- **–î–µ–π—Å—Ç–≤–∏—è:**
  - –ü–æ–ª—É—á–∏—Ç—å userId
  - –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –≤ `chats`
  - –í–æ–∑–≤—Ä–∞—Ç chatId

#### 1.5. Workflow: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
- **Endpoint:** `POST /webhook/analytics`
- **–î–µ–π—Å—Ç–≤–∏—è:**
  - –ü–æ–ª—É—á–∏—Ç—å event_type –∏ event_data
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ `analytics_events`
  - –í–æ–∑–≤—Ä–∞—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Frontend (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –í–´–°–û–ö–ò–ô)

#### 2.1. –°–æ–∑–¥–∞—Ç—å API –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
- –§–∞–π–ª: `src/config/api.ts`
- –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è: `REACT_APP_API_URL`

#### 2.2. –û–±–Ω–æ–≤–∏—Ç—å VoiceAssistantPage
- –ü–æ–¥–∫–ª—é—á–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ë–î
- –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

#### 2.3. –°–æ–∑–¥–∞—Ç—å —Ö–µ–ª–ø–µ—Ä—ã –¥–ª—è API
- `src/utils/api.ts` - –±–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ API
- –¢–∏–ø–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—Ç–≤–µ—Ç–æ–≤

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –°–†–ï–î–ù–ò–ô)

- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö API endpoints
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ frontend-backend
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

### 4. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ù–ò–ó–ö–ò–ô)

- [ ] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–æ–≤
- [ ] –ò–Ω–¥–µ–∫—Å—ã –ë–î –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### 5. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –í–´–°–û–ö–ò–ô –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)

- [ ] –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram initData
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] Rate limiting –¥–ª—è API
- [ ] HTTPS –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

## üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é n8n Workflow

### –ü—Ä–∏–º–µ—Ä: Workflow "Save Message"

1. –û—Ç–∫—Ä–æ–π—Ç–µ n8n: http://localhost:5678
2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π workflow
3. –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–¥—É **Webhook**:
   - –ú–µ—Ç–æ–¥: POST
   - Path: `/save-message`
   - Response: JSON
4. –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–¥—É **Code** –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
5. –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–¥—É **PostgreSQL**:
   - –û–ø–µ—Ä–∞—Ü–∏—è: Insert
   - –¢–∞–±–ª–∏—Ü–∞: `messages`
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –Ω–æ–¥—ã
6. –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–¥—É **Respond to Webhook**:
   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å—Ç–∞—Ç—É—Å 200
   - –í–µ—Ä–Ω–∏—Ç–µ JSON —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL –≤ n8n

- Host: `supabase-db`
- Port: `5432`
- Database: `lumon`
- User: `postgres`
- Password: `lumon_dev_password` (–∏–∑ .env)

