# ğŸ” ĞŸĞ»Ğ°Ğ½ Ğ´Ğ¾Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ¾Ğº: ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ, Ñ€Ğ¾Ğ»Ğ¸ Ğ¸ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° n8n (ĞĞ¾ÑĞ±Ñ€ÑŒ 2025)

## ğŸ¯ Ğ¦ĞµĞ»ÑŒ
Ğ¡Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ ĞºĞ°Ğº Ñƒ ĞºĞ»Ğ°ÑÑĞ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹ Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸ĞµĞ¹: ĞµĞ´Ğ¸Ğ½Ğ°Ñ ÑĞµÑÑĞ¸Ñ, Ñ€Ğ¾Ğ»Ğ¸/ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸, Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞµ, ĞµĞ´Ğ¸Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ¸ Ğ¿Ñ€ĞµĞ´ÑĞºĞ°Ğ·ÑƒĞµĞ¼Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ²Ğ¾Ñ€ĞºÑ„Ğ»Ğ¾Ñƒ.

---

## ğŸ“‹ ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° (Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ)

**Ğ§Ñ‚Ğ¾ ĞµÑÑ‚ÑŒ ÑĞµĞ¹Ñ‡Ğ°Ñ:**
- ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ·Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ñ‡ĞµÑ€ĞµĞ· Telegram Mini App
- Ğ—Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¿Ñ€Ğ¾Ñ…Ğ¾Ğ´ÑÑ‚ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ Ğº Ñ€Ğ°Ğ·Ğ½Ñ‹Ğ¼ Ğ²Ğ¾Ñ€ĞºÑ„Ğ»Ğ¾Ñƒ Ğ² n8n
- ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¾Ğº Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ½ĞµÑ‚
- Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ñ€Ğ°Ğ·Ğ±Ñ€Ğ¾ÑĞ°Ğ½Ğ° Ğ¿Ğ¾ Ñ€Ğ°Ğ·Ğ½Ñ‹Ğ¼ Ğ¼ĞµÑÑ‚Ğ°Ğ¼
- ĞĞµÑ‚ Ğ¿Ğ¾Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ñ Ñ€Ğ¾Ğ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (owner/manager)
- ĞĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ²ÑĞ·ĞºĞ¸ Ğº ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸
- ĞĞµÑ‚ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ¿Ğ¾Ğ¸ÑĞºĞ° per-user
- Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ½Ğµ Ğ¸Ğ·Ğ¾Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ¿Ğ¾ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸ÑĞ¼

**Ğ§Ñ‚Ğ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾:**
- ĞŸÑ€Ğ¸ Ğ²Ñ…Ğ¾Ğ´Ğµ: Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Telegram ID â†’ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ Ñ€Ğ¾Ğ»ÑŒ â†’ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸
- Ğ•ÑĞ»Ğ¸ Ñ€Ğ¾Ğ»ÑŒ owner â†’ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ²Ğ¾ĞµĞ¹ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸
- Ğ•ÑĞ»Ğ¸ Ñ€Ğ¾Ğ»ÑŒ manager â†’ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ²Ğ¾ĞµĞ¹ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸ (Ñ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸ÑĞ¼Ğ¸)
- Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ñ‚ÑŒ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ğ¾Ğ¸ÑĞºĞ° Ğ´Ğ»Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
- Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ñ‡ĞµÑ€ĞµĞ· ĞµĞ´Ğ¸Ğ½ÑƒÑ Ñ‚Ğ¾Ñ‡ĞºÑƒ (ĞºĞ°Ğº middleware Ğ² Express)
- Ğ•Ğ´Ğ¸Ğ½Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ¸ ÑƒÑĞ¿ĞµÑˆĞ½Ñ‹Ñ… Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ²

---

## ğŸ—ï¸ ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° n8n (ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ²Ğ¾Ñ€ĞºÑ„Ğ»Ğ¾Ñƒ)

### ĞĞ±Ñ‰Ğ°Ñ ÑÑ…ĞµĞ¼Ğ°
```
/auth/
  â”œâ”€â”€ init          # Webhook: Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Telegram initData â†’ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ HMAC â†’ upsert user â†’ ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ ÑĞµÑÑĞ¸Ñ â†’ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ session_token + context
  â”œâ”€â”€ validate      # Subworkflow: Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ session_token, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ context (userId, role, companyId, permissions) Ğ¸Ğ»Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ 401/403
  â”œâ”€â”€ refresh       # Subworkflow: Ğ¿Ñ€Ğ¾Ğ´Ğ»ĞµĞ²Ğ°ĞµÑ‚ ÑĞµÑÑĞ¸Ñ Ğ¿Ñ€Ğ¸ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ (ÑĞºĞ¾Ğ»ÑŒĞ·ÑÑ‰ĞµĞµ Ğ¾ĞºĞ½Ğ¾ + grace period)
  â””â”€â”€ authorize     # Subworkflow: Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ¿Ñ€Ğ°Ğ²Ğ¾ Ğ½Ğ° Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ (RBAC + Ğ²Ğ»Ğ°Ğ´ĞµĞ½Ğ¸Ğµ Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ¼)

/chat/
  â”œâ”€â”€ create        # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ‡Ğ°Ñ‚Ğ° (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾ÑĞ»Ğµ validate/authorize)
  â”œâ”€â”€ getHistory    # Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ñ‡Ğ°Ñ‚Ğ° (Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ñ‡Ğ°Ñ‚Ñƒ/ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸)
  â””â”€â”€ saveMessage   # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ (Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°)

/analytics/
  â””â”€â”€ logEvent      # Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ (Ñ‡ĞµÑ€ĞµĞ· validate)
```

### Ğ£Ğ½Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½ Ğ´Ğ»Ñ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ²Ğ¾Ñ€ĞºÑ„Ğ»Ğ¾Ñƒ
**ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹** Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ²Ğ¾Ñ€ĞºÑ„Ğ»Ğ¾Ñƒ ÑĞ»ĞµĞ´ÑƒĞµÑ‚ ÑÑ‚Ğ¾Ğ¹ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğµ:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Webhook Node (Ñ‚Ñ€Ğ¸Ğ³Ğ³ĞµÑ€)                               â”‚
â”‚    - ĞŸÑ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ñ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¾Ğ¼ Authorization        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Execute Workflow: auth.validate                      â”‚
â”‚    - Input: { token: $headers.authorization }           â”‚
â”‚    - Output: context { userId, role, companyId }        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. IF Node: Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸                     â”‚
â”‚    - Ğ•ÑĞ»Ğ¸ error â†’ Response (401/403)                    â”‚
â”‚    - Ğ˜Ğ½Ğ°Ñ‡Ğµ â†’ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Ğ‘Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°                                        â”‚
â”‚    - Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğº context.userId, context.companyId         â”‚
â”‚    - Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ companyId                            â”‚
â”‚    - Ğ—Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ² Ğ‘Ğ” Ñ WHERE company_id = context.companyIdâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Response Node                                        â”‚
â”‚    - Ğ•Ğ´Ğ¸Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ { success, data, traceId }           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¡ ĞšĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚Ñ‹ API

### Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸ (ĞºĞ¾Ğ½Ğ²ĞµĞ½Ñ†Ğ¸Ğ¸)
```http
Authorization: Bearer <session_token>
X-Request-Id: <uuid>              # Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾, Ğ´Ğ»Ñ Ñ‚Ñ€ĞµĞ¹ÑĞ¸Ğ½Ğ³Ğ°
Idempotency-Key: <uuid>           # Ğ´Ğ»Ñ mutating-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
Content-Type: application/json
```

### Ğ•Ğ´Ğ¸Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
```json
{
  "error": "unauthorized",
  "status": 401,
  "message": "Invalid or expired token",
  "traceId": "550e8400-e29b-41d4-a716-446655440000"
}
```

**ĞšĞ¾Ğ´Ñ‹ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº:**
- `400` - Bad Request (Ğ½ĞµĞ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ)
- `401` - Unauthorized (Ğ½ĞµÑ‚ Ñ‚Ğ¾ĞºĞµĞ½Ğ° / Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½ / Ğ½ĞµĞ²Ğ°Ğ»Ğ¸Ğ´ĞµĞ½)
- `403` - Forbidden (Ñ‚Ğ¾ĞºĞµĞ½ Ğ²Ğ°Ğ»Ğ¸Ğ´ĞµĞ½, Ğ½Ğ¾ Ğ½ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² Ğ½Ğ° Ñ€ĞµÑÑƒÑ€Ñ)
- `404` - Not Found (Ñ€ĞµÑÑƒÑ€Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½)
- `429` - Too Many Requests (rate limit)
- `500` - Internal Server Error

### Ğ•Ğ´Ğ¸Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ ÑƒÑĞ¿ĞµÑ…Ğ°
```json
{
  "success": true,
  "data": {
    /* payload */
  },
  "traceId": "550e8400-e29b-41d4-a716-446655440000"
}
```

---

## ğŸ” Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ²Ğ¾Ñ€ĞºÑ„Ğ»Ğ¾Ñƒ

### 1ï¸âƒ£ `/webhook/auth-init` (POST) - Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑĞµÑÑĞ¸Ğ¸

**ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ:** ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ğµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Telegram initData, ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ, ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ ÑĞµÑÑĞ¸Ñ.

**Input:**
```json
{
  "initData": "query_id=AAHdF6IQAAAAAN0XohDhrOrc&user=%7B%22id%22%3A279058397...",
  "appVersion": "1.0.0"
}
```

**Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° (Ğ±Ğ»Ğ¾Ğº-ÑÑ…ĞµĞ¼Ğ°):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Function: Verify Telegram initData  â”‚
â”‚    - Ğ˜Ğ·Ğ²Ğ»ĞµÑ‡ÑŒ hash Ğ¸ data                â”‚
â”‚    - HMAC_SHA256 Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°               â”‚
â”‚    - ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ auth_date (< 5 min)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Valid?         â”‚
      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
           â”‚NO    â”‚YES
           â–¼      â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Return â”‚ â”‚ 2. Postgres: UPSERT    â”‚
      â”‚ 401    â”‚ â”‚    users by telegram_idâ”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚ 3. Postgres: SELECT role    â”‚
               â”‚    FROM user_companies      â”‚
               â”‚    WHERE user_id = $1       â”‚
               â”‚    LIMIT 1                  â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚ 4. Postgres: INSERT session â”‚
               â”‚    - id (uuid)              â”‚
               â”‚    - user_id                â”‚
               â”‚    - expires_at = now()+7d  â”‚
               â”‚    RETURNING id             â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚ 5. Response: 200            â”‚
               â”‚    { session_token, user,   â”‚
               â”‚      companyId, role }      â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Output (ÑƒÑĞ¿ĞµÑ…):**
```json
{
  "success": true,
  "data": {
    "session_token": "550e8400-e29b-41d4-a716-446655440000",
    "user": {
      "id": "123e4567-e89b-12d3-a456-426614174000",
      "telegram_id": 279058397,
      "username": "john_doe",
      "first_name": "John",
      "last_name": "Doe"
    },
    "companyId": "c0e4567-e89b-12d3-a456-426614174999",
    "role": "owner"
  },
  "traceId": "..."
}
```

**n8n Ğ½Ğ¾Ğ´Ñ‹ (Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸):**
```
1. Webhook Trigger
   - Path: /webhook/auth-init
   - Method: POST
   
2. Function: Verify Telegram initData
   - Code: (ÑĞ¼. ÑĞµĞºÑ†Ğ¸Ñ "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Telegram initData")
   
3. Postgres: Upsert User
   - Query: 
     INSERT INTO users (telegram_id, username, first_name, last_name, language_code)
     VALUES ($1, $2, $3, $4, $5)
     ON CONFLICT (telegram_id) 
     DO UPDATE SET username = $2, first_name = $3, last_name = $4, updated_at = now()
     RETURNING id, telegram_id, username, first_name, last_name
   
4. Postgres: Get User Company & Role
   - Query:
     SELECT uc.company_id, uc.role, c.name as company_name
     FROM user_companies uc
     JOIN companies c ON c.id = uc.company_id
     WHERE uc.user_id = $1
     LIMIT 1
   
5. Postgres: Create Session
   - Query:
     INSERT INTO sessions (user_id, expires_at, user_agent, ip)
     VALUES ($1, now() + interval '7 days', $2, $3)
     RETURNING id, expires_at
   
6. Function: Format Response
   - Code: return { success: true, data: { ... }, traceId: uuidv4() }
   
7. Response Node
```

---

### 2ï¸âƒ£ Subworkflow: `auth.validate` - Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ°

**ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ:** ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ session_token, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ context Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ. Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ² **ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼** Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ²Ğ¾Ñ€ĞºÑ„Ğ»Ğ¾Ñƒ.

**Input:**
```json
{
  "token": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Ğ›Ğ¾Ğ³Ğ¸ĞºĞ°:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Postgres: SELECT session             â”‚
â”‚    WHERE id = $token AND                â”‚
â”‚          expires_at > now()             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Found?         â”‚
      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
           â”‚NO    â”‚YES
           â–¼      â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Return â”‚ â”‚ 2. UPDATE last_seen_at â”‚
      â”‚ Error  â”‚ â”‚    = now()             â”‚
      â”‚ 401    â”‚ â”‚    WHERE id = $token   â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚ 3. IF expires_at - now()    â”‚
               â”‚    < 5 minutes (grace)?     â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚YES            â”‚NO
                      â–¼               â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ UPDATE expires_at  â”‚  â”‚ Skip     â”‚
         â”‚ = now() + 7d       â”‚  â”‚          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                   â”‚                  â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚ 4. Postgres: Get User +     â”‚
               â”‚    Company + Role           â”‚
               â”‚    JOIN user_companies      â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚ 5. Return context           â”‚
               â”‚    { userId, role,          â”‚
               â”‚      companyId, permissions}â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Output (ÑƒÑĞ¿ĞµÑ…):**
```json
{
  "context": {
    "userId": "123e4567-e89b-12d3-a456-426614174000",
    "role": "owner",
    "companyId": "c0e4567-e89b-12d3-a456-426614174999",
    "permissions": ["read", "write", "delete"]
  }
}
```

**Output (Ğ¾ÑˆĞ¸Ğ±ĞºĞ°):**
```json
{
  "error": "unauthorized",
  "status": 401,
  "message": "Invalid or expired token",
  "traceId": "..."
}
```

**n8n Ğ½Ğ¾Ğ´Ñ‹:**
```
1. Workflow Trigger (ÑÑƒĞ±Ğ²Ğ¾Ñ€ĞºÑ„Ğ»Ğ¾Ñƒ)
   - Input: token

2. Postgres: Check Session
   - Query:
     SELECT s.id, s.user_id, s.expires_at, s.last_seen_at
     FROM sessions s
     WHERE s.id = $1::uuid AND s.expires_at > now()
     LIMIT 1

3. IF: Session Exists?
   - false â†’ Error Response (401)

4. Postgres: Update last_seen_at
   - Query: UPDATE sessions SET last_seen_at = now() WHERE id = $1

5. Function: Check Grace Period & Extend
   - Code:
     const expiresAt = new Date($input.expires_at);
     const now = new Date();
     const diff = (expiresAt - now) / 1000 / 60; // minutes
     return { shouldExtend: diff < 5 };

6. IF: shouldExtend?
   - true â†’ Postgres: UPDATE sessions SET expires_at = now() + interval '7 days' WHERE id = $1

7. Postgres: Get User Context
   - Query:
     SELECT u.id as user_id, uc.role, uc.company_id
     FROM users u
     LEFT JOIN user_companies uc ON uc.user_id = u.id
     WHERE u.id = $1
     LIMIT 1

8. Function: Build Permissions
   - Code:
     const permissions = [];
     if (role === 'owner') permissions = ['read', 'write', 'delete'];
     if (role === 'manager') permissions = ['read', 'write'];
     if (role === 'viewer') permissions = ['read'];
     return { context: { userId, role, companyId, permissions } };

9. Return: context
```

---

### 3ï¸âƒ£ Subworkflow: `auth.refresh` - ĞŸÑ€Ğ¾Ğ´Ğ»ĞµĞ½Ğ¸Ğµ ÑĞµÑÑĞ¸Ğ¸

**ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ:** Ğ¯Ğ²Ğ½Ğ¾Ğµ Ğ¿Ñ€Ğ¾Ğ´Ğ»ĞµĞ½Ğ¸Ğµ ÑĞµÑÑĞ¸Ğ¸ (Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€Ñƒ Ñ Ñ„Ñ€Ğ¾Ğ½Ñ‚Ğ°).

**Input:**
```json
{
  "token": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Ğ›Ğ¾Ğ³Ğ¸ĞºĞ°:**
```sql
UPDATE sessions 
SET expires_at = now() + interval '7 days',
    last_seen_at = now()
WHERE id = $1::uuid 
  AND expires_at > now()
RETURNING expires_at;
```

**Output:**
```json
{
  "success": true,
  "data": {
    "expires_at": "2025-11-11T10:00:00Z"
  }
}
```

---

### 4ï¸âƒ£ Subworkflow: `auth.authorize` - ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ñ€Ğ°Ğ² Ğ½Ğ° Ñ€ĞµÑÑƒÑ€Ñ

**ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ:** RBAC-ÑˆĞµĞ¹Ğ¿ĞµÑ€ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ¼Ñƒ Ñ€ĞµÑÑƒÑ€ÑÑƒ.

**Input:**
```json
{
  "context": {
    "userId": "...",
    "role": "manager",
    "companyId": "..."
  },
  "resource": "chat",
  "action": "delete",
  "resourceId": "chat-uuid-123"
}
```

**Ğ›Ğ¾Ğ³Ğ¸ĞºĞ°:**
```
1. IF action === 'delete' && role !== 'owner' â†’ return { allowed: false, error: 403 }
2. IF resource === 'chat':
   - SELECT company_id FROM chats WHERE id = resourceId
   - IF company_id !== context.companyId â†’ return { allowed: false, error: 403 }
3. ELSE return { allowed: true }
```

**Output:**
```json
{
  "allowed": true
}
```

Ğ¸Ğ»Ğ¸

```json
{
  "allowed": false,
  "error": "forbidden",
  "status": 403,
  "message": "You don't have permission to delete this resource"
}
```

---

### 5ï¸âƒ£ `/webhook/auth-logout` (POST) - Ğ’Ñ‹Ñ…Ğ¾Ğ´

**Input:**
```json
{
  "token": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Ğ›Ğ¾Ğ³Ğ¸ĞºĞ°:**
```sql
DELETE FROM sessions WHERE id = $1::uuid;
```

**Output:**
```json
{
  "success": true
}
```

---

### 6ï¸âƒ£ `/webhook/auth-switch-company` (POST, Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾) - Ğ¡Ğ¼ĞµĞ½Ğ° ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸

**ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ:** Ğ”Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹, Ğ¿Ñ€Ğ¸Ğ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ñ… Ğº Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¸Ğ¼ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸ÑĞ¼.

**Input:**
```json
{
  "token": "...",
  "companyId": "new-company-uuid"
}
```

**Ğ›Ğ¾Ğ³Ğ¸ĞºĞ°:**
```
1. auth.validate(token) â†’ context
2. SELECT 1 FROM user_companies WHERE user_id = context.userId AND company_id = $companyId
3. IF not found â†’ error 403
4. UPDATE sessions SET active_company_id = $companyId WHERE id = $token (Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºÑƒ active_company_id)
5. Return success
```

**Output:**
```json
{
  "success": true,
  "data": {
    "companyId": "new-company-uuid"
  }
}
```

## ğŸ—„ï¸ Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾)

### Ğ¡Ñ…ĞµĞ¼Ğ° Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†

#### `users` - ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  telegram_id BIGINT UNIQUE NOT NULL,
  username TEXT,
  first_name TEXT,
  last_name TEXT,
  language_code TEXT DEFAULT 'ru',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_users_telegram_id ON users(telegram_id);
```

#### `companies` - ĞšĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸
```sql
CREATE TABLE companies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  settings JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

#### `user_companies` - Ğ¡Ğ²ÑĞ·ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ¸ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¹ + Ñ€Ğ¾Ğ»Ğ¸
```sql
CREATE TABLE user_companies (
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
  role TEXT NOT NULL CHECK (role IN ('owner', 'manager', 'viewer')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  PRIMARY KEY (user_id, company_id)
);

CREATE INDEX idx_user_companies_user ON user_companies(user_id);
CREATE INDEX idx_user_companies_company ON user_companies(company_id);
```

#### `sessions` - Ğ¡ĞµÑÑĞ¸Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
```sql
CREATE TABLE sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  expires_at TIMESTAMPTZ NOT NULL,
  last_seen_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  user_agent TEXT,
  ip TEXT,
  active_company_id UUID REFERENCES companies(id) ON DELETE SET NULL  -- Ğ´Ğ»Ñ switch-company
);

CREATE INDEX idx_sessions_user ON sessions(user_id);
CREATE INDEX idx_sessions_expires ON sessions(expires_at);

-- ĞĞ²Ñ‚Ğ¾ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ñ… ÑĞµÑÑĞ¸Ğ¹ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾, Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ñ‡ĞµÑ€ĞµĞ· cron)
-- CREATE INDEX idx_sessions_expired ON sessions(expires_at) WHERE expires_at < now();
```

#### `chats` - Ğ§Ğ°Ñ‚Ñ‹
```sql
CREATE TABLE chats (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE SET NULL,
  company_id UUID REFERENCES companies(id) ON DELETE SET NULL,
  title TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_chats_user ON chats(user_id);
CREATE INDEX idx_chats_company ON chats(company_id);
CREATE INDEX idx_chats_created ON chats(created_at DESC);
```

#### `messages` - Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ² Ñ‡Ğ°Ñ‚Ğ°Ñ…
```sql
CREATE TABLE messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  chat_id UUID NOT NULL REFERENCES chats(id) ON DELETE CASCADE,
  role TEXT NOT NULL CHECK (role IN ('user', 'assistant', 'system')),
  content TEXT NOT NULL,
  metadata JSONB DEFAULT '{}',  -- Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ², Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ¸ Ñ‚.Ğ´.
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_messages_chat ON messages(chat_id);
CREATE INDEX idx_messages_created ON messages(created_at DESC);
```

#### `audit_events` - ĞÑƒĞ´Ğ¸Ñ‚ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾, Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ)
```sql
CREATE TABLE audit_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE SET NULL,
  company_id UUID REFERENCES companies(id) ON DELETE SET NULL,
  action TEXT NOT NULL,  -- 'chat.create', 'message.save', 'auth.login', etc
  resource TEXT,         -- 'chat', 'message', 'user'
  resource_id UUID,
  meta JSONB DEFAULT '{}',
  ip TEXT,
  user_agent TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_audit_user ON audit_events(user_id);
CREATE INDEX idx_audit_company ON audit_events(company_id);
CREATE INDEX idx_audit_created ON audit_events(created_at DESC);
CREATE INDEX idx_audit_action ON audit_events(action);
```

#### `idempotency_keys` - Ğ˜Ğ´ĞµĞ¼Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
```sql
CREATE TABLE idempotency_keys (
  key UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  endpoint TEXT NOT NULL,
  response JSONB NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_idempotency_created ON idempotency_keys(created_at);

-- ĞĞ²Ñ‚Ğ¾ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ€Ñ‹Ñ… ĞºĞ»ÑÑ‡ĞµĞ¹ (> 24h)
-- DELETE FROM idempotency_keys WHERE created_at < now() - interval '24 hours';
```

#### `rate_limits` - Rate limiting (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
```sql
CREATE TABLE rate_limits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
  endpoint TEXT NOT NULL,
  minute_bucket TIMESTAMPTZ NOT NULL,  -- Ğ¾ĞºÑ€ÑƒĞ³Ğ»Ñ‘Ğ½Ğ½Ğ°Ñ Ğ´Ğ¾ Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹ timestamp
  count INTEGER DEFAULT 1,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE (user_id, endpoint, minute_bucket)
);

CREATE INDEX idx_rate_limits_bucket ON rate_limits(minute_bucket);
```

### ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ (Ğ¿Ğ¾Ñ€ÑĞ´Ğ¾Ğº ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ)

**Ğ¤Ğ°Ğ¹Ğ»:** `back/supabase/migrations/YYYYMMDD_auth_system.sql`

```sql
-- 1. users (ĞµÑĞ»Ğ¸ ĞµÑ‰Ñ‘ Ğ½ĞµÑ‚)
-- 2. companies
-- 3. user_companies
-- 4. sessions (Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ active_company_id ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾ switch-company)
-- 5. chats (ĞµÑĞ»Ğ¸ ĞµÑ‰Ñ‘ Ğ½ĞµÑ‚)
-- 6. messages (ĞµÑĞ»Ğ¸ ĞµÑ‰Ñ‘ Ğ½ĞµÑ‚)
-- 7. audit_events (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
-- 8. idempotency_keys (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
-- 9. rate_limits (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
```

## â±ï¸ Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° ÑĞµÑÑĞ¸Ğ¹ (Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾)

### Ğ¡Ñ€Ğ¾Ğº Ğ¶Ğ¸Ğ·Ğ½Ğ¸ Ğ¸ Ğ¿Ñ€Ğ¾Ğ´Ğ»ĞµĞ½Ğ¸Ğµ

**ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹:**
- ĞĞ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑÑ€Ğ¾Ğº: `7 Ğ´Ğ½ĞµĞ¹` (Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ)
- Grace window: `5 Ğ¼Ğ¸Ğ½ÑƒÑ‚` (ĞµÑĞ»Ğ¸ Ğ´Ğ¾ Ğ¸ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸Ñ Ğ¾ÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ Ğ¼ĞµĞ½ÑŒÑˆĞµ 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚ â€” Ğ°Ğ²Ñ‚Ğ¾Ğ¿Ñ€Ğ¾Ğ´Ğ»ĞµĞ½Ğ¸Ğµ)
- Ğ¡ĞºĞ¾Ğ»ÑŒĞ·ÑÑ‰ĞµĞµ Ğ¾ĞºĞ½Ğ¾: Ğ¿Ñ€Ğ¸ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ `last_seen_at`

**ĞŸĞ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ:**

1. **ĞŸÑ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ ÑĞµÑÑĞ¸Ğ¸ (`auth.init`):**
```sql
INSERT INTO sessions (user_id, expires_at, user_agent, ip)
VALUES ($userId, now() + interval '7 days', $userAgent, $ip)
RETURNING id;
```

2. **ĞŸÑ€Ğ¸ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ (`auth.validate`):**
```javascript
// Ğ’ Function Node
const session = $input.session; // Ğ¸Ğ· Ğ‘Ğ”
const now = new Date();
const expiresAt = new Date(session.expires_at);
const minutesLeft = (expiresAt - now) / 1000 / 60;

// Grace window: ĞµÑĞ»Ğ¸ Ğ¾ÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ < 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
if (minutesLeft < 5 && minutesLeft > 0) {
  // ĞĞ²Ñ‚Ğ¾Ğ¿Ñ€Ğ¾Ğ´Ğ»ĞµĞ½Ğ¸Ğµ
  await db.query(`
    UPDATE sessions 
    SET expires_at = now() + interval '7 days',
        last_seen_at = now()
    WHERE id = $1
  `, [session.id]);
} else {
  // ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ last_seen_at
  await db.query(`
    UPDATE sessions 
    SET last_seen_at = now()
    WHERE id = $1
  `, [session.id]);
}
```

3. **Ğ¯Ğ²Ğ½Ğ¾Ğµ Ğ¿Ñ€Ğ¾Ğ´Ğ»ĞµĞ½Ğ¸Ğµ (`auth.refresh`):**
- Ğ¤Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€Ñƒ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 4 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹)
- Ğ˜Ğ»Ğ¸ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ `auth.validate` (Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸)

### Ğ˜Ğ½Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ ÑĞµÑÑĞ¸Ğ¸

**ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ñ‹:**
- Ğ¯Ğ²Ğ½Ñ‹Ğ¹ logout (`/webhook/auth-logout`)
- Ğ˜ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸Ğµ ÑÑ€Ğ¾ĞºĞ° (`expires_at < now()`)
- Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (CASCADE)

**ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ñ… ÑĞµÑÑĞ¸Ğ¹ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾):**
```sql
-- ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· cron Ğ² n8n (Schedule Trigger)
DELETE FROM sessions WHERE expires_at < now();
```

---

## ğŸ”’ RBAC/Authorize (Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾)

### Ğ Ğ¾Ğ»Ğ¸ Ğ¸ Ğ¿Ñ€Ğ°Ğ²Ğ°

| Ğ Ğ¾Ğ»ÑŒ      | ĞŸÑ€Ğ°Ğ²Ğ°                                | ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ                        |
|-----------|--------------------------------------|-------------------------------------|
| `owner`   | read, write, delete                 | ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸     |
| `manager` | read, write                         | ĞĞµÑ‚ delete, Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½ Ğ½Ğ° Ğ½ĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ñ€ĞµÑÑƒÑ€ÑÑ‹ |
| `viewer`  | read                                | Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡Ñ‚ĞµĞ½Ğ¸Ğµ                       |

### ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ñ€ĞµÑÑƒÑ€ÑĞ°Ğ¼

**ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿:** Ğ’ÑĞµĞ³Ğ´Ğ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑÑ‚ÑŒ `resource.company_id == context.companyId` Ğ˜Ğ›Ğ˜ `resource.user_id == context.userId`.

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹:**

#### Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ñ‡Ğ°Ñ‚Ğ°
```sql
-- Ğ’ Ğ²Ğ¾Ñ€ĞºÑ„Ğ»Ğ¾Ñƒ chat.getHistory
SELECT m.* 
FROM messages m
JOIN chats c ON c.id = m.chat_id
WHERE c.id = $chatId
  AND (c.company_id = $context.companyId OR c.user_id = $context.userId)
ORDER BY m.created_at DESC;
```

#### Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ‡Ğ°Ñ‚Ğ°
```sql
-- Ğ’ Ğ²Ğ¾Ñ€ĞºÑ„Ğ»Ğ¾Ñƒ chat.create
INSERT INTO chats (user_id, company_id, title)
VALUES ($context.userId, $context.companyId, $title)
RETURNING *;
```

#### Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ñ‡Ğ°Ñ‚Ğ° (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ owner)
```javascript
// Ğ’ Function Node Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ chat.delete
if (context.role !== 'owner') {
  return {
    error: 'forbidden',
    status: 403,
    message: 'Only owners can delete chats'
  };
}

// ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ²Ğ»Ğ°Ğ´ĞµĞ½Ğ¸Ğµ Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ¼
const chat = await db.query(`
  SELECT company_id FROM chats WHERE id = $1
`, [chatId]);

if (chat.company_id !== context.companyId) {
  return { error: 'forbidden', status: 403 };
}

// OK, ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼
await db.query(`DELETE FROM chats WHERE id = $1`, [chatId]);
```

### Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ `auth.authorize` subworkflow

**ĞšĞ¾Ğ³Ğ´Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ:**
- Ğ”Ğ»Ñ ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¾Ğº (delete, update ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²)
- Ğ”Ğ»Ñ Ñ†ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸ RBAC

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ° Ğ² Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ²Ğ¾Ñ€ĞºÑ„Ğ»Ğ¾Ñƒ:**
```
1. Execute Workflow: auth.validate â†’ context
2. Execute Workflow: auth.authorize
   Input: { context, resource: 'chat', action: 'delete', resourceId: $chatId }
3. IF: authorize.allowed === false â†’ Response 403
4. ELSE: Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ
```

---

## ğŸ›¡ï¸ Ğ˜Ğ´ĞµĞ¼Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¸ Rate Limiting (Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾)

### Ğ˜Ğ´ĞµĞ¼Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ

**Ğ¦ĞµĞ»ÑŒ:** ĞŸÑ€ĞµĞ´Ğ¾Ñ‚Ğ²Ñ€Ğ°Ñ‚Ğ¸Ñ‚ÑŒ Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°Ñ… (network retry, user double-click).

**Ğ­Ğ½Ğ´Ğ¿Ğ¾Ğ¹Ğ½Ñ‚Ñ‹, Ñ‚Ñ€ĞµĞ±ÑƒÑÑ‰Ğ¸Ğµ Ğ¸Ğ´ĞµĞ¼Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚Ğ¸:**
- `/webhook/chat.save-message`
- `/webhook/chat.create`
- `/webhook/analytics.log-event`

**Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ² n8n:**

```
1. Webhook Node â†’ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚ÑŒ `Idempotency-Key` Ğ¸Ğ· Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ°
2. Function: Check Idempotency
   Code:
     const key = $headers['idempotency-key'];
     if (!key) { 
       return { skip: true }; // Ğ½Ğµ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ
     }
     
     const existing = await db.query(`
       SELECT response FROM idempotency_keys WHERE key = $1
     `, [key]);
     
     if (existing) {
       // Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚
       return { cached: true, response: existing.response };
     }
     
     return { skip: false, key };

3. IF: cached === true â†’ Response (ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚)
4. ELSE: Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ
5. ĞŸĞ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ³Ğ¾ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ:
   INSERT INTO idempotency_keys (key, user_id, endpoint, response)
   VALUES ($key, $userId, $endpoint, $response);
6. Response
```

**ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ÑÑ‚Ğ°Ñ€Ñ‹Ñ… ĞºĞ»ÑÑ‡ĞµĞ¹:**
```sql
-- Ğ§ĞµÑ€ĞµĞ· Schedule Trigger (Ñ€Ğ°Ğ· Ğ² Ñ‡Ğ°Ñ)
DELETE FROM idempotency_keys WHERE created_at < now() - interval '24 hours';
```

### Rate Limiting

**Ğ¦ĞµĞ»ÑŒ:** Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ ÑĞ¿Ğ°Ğ¼Ğ° Ğ¸ DDoS.

**Ğ›Ğ¸Ğ¼Ğ¸Ñ‚Ñ‹ (Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹):**
- `/webhook/chat.save-message`: 30 Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²/Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ per user
- `/webhook/analytics.log-event`: 100 Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²/Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ per company

**Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ² n8n:**

```
1. Function: Check Rate Limit
   Code:
     const now = new Date();
     const bucket = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 
                             now.getHours(), now.getMinutes(), 0); // Ğ¾ĞºÑ€ÑƒĞ³Ğ»ÑĞµĞ¼ Ğ´Ğ¾ Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹
     
     const result = await db.query(`
       INSERT INTO rate_limits (user_id, endpoint, minute_bucket, count)
       VALUES ($1, $2, $3, 1)
       ON CONFLICT (user_id, endpoint, minute_bucket)
       DO UPDATE SET count = rate_limits.count + 1
       RETURNING count
     `, [userId, endpoint, bucket]);
     
     const limit = 30; // ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³
     if (result.count > limit) {
       return { exceeded: true, count: result.count, limit };
     }
     
     return { exceeded: false };

2. IF: exceeded === true â†’ Response 429 (Too Many Requests)
3. ELSE: Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ
```

**ĞÑ‡Ğ¸ÑÑ‚ĞºĞ°:**
```sql
-- Ğ Ğ°Ğ· Ğ² Ñ‡Ğ°Ñ ÑƒĞ´Ğ°Ğ»ÑÑ‚ÑŒ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ bucket'Ñ‹
DELETE FROM rate_limits WHERE minute_bucket < now() - interval '1 hour';
```

## ğŸ¨ Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ½Ğ° Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ğµ (Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾)

### 1. Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ğµ (`src/main.tsx` Ğ¸Ğ»Ğ¸ `src/App.tsx`)

**Ğ§Ñ‚Ğ¾ Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ:**
- ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ `session_token` Ğ² `localStorage`
- Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚ â†’ Ğ²Ñ‹Ğ·Ğ²Ğ°Ñ‚ÑŒ `/webhook/auth-init` Ñ Telegram `initData`
- Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ `session_token` Ğ¸ `context` (userId, role, companyId)

**ĞšĞ¾Ğ´ (Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€ Ğ² `src/App.tsx`):**

```typescript
useEffect(() => {
  const initAuth = async () => {
    const existingToken = localStorage.getItem('session_token');
    
    if (existingToken) {
      // ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾ÑÑ‚ÑŒ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾, Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ)
      setSessionToken(existingToken);
      return;
    }

    // Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚ Ñ‚Ğ¾ĞºĞµĞ½Ğ° Ğ¸ ÑÑ‚Ğ¾ Telegram Mini App
    if (window.Telegram?.WebApp?.initData) {
      try {
        const response = await fetch('/webhook/auth-init', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            initData: window.Telegram.WebApp.initData,
            appVersion: '1.0.0'
          })
        });

        const data = await response.json();
        
        if (data.success) {
          localStorage.setItem('session_token', data.data.session_token);
          localStorage.setItem('user_context', JSON.stringify({
            userId: data.data.user.id,
            role: data.data.role,
            companyId: data.data.companyId
          }));
          setSessionToken(data.data.session_token);
        }
      } catch (error) {
        console.error('Auth init failed:', error);
        // ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ Ğ¸Ğ»Ğ¸ retry
      }
    }
  };

  initAuth();
}, []);
```

### 2. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ `Authorization` Ğ² API Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ (`src/utils/api.ts`)

**ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ `getDefaultHeaders()`:**

```typescript
const getDefaultHeaders = (): HeadersInit => {
  const token = localStorage.getItem('session_token');
  
  const headers: HeadersInit = {
    'Content-Type': 'application/json',
  };

  if (token) {
    headers['Authorization'] = `Bearer ${token}`;
  }

  return headers;
};

// Ğ”Ğ»Ñ Ğ¸Ğ´ĞµĞ¼Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ‚Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
const getIdempotentHeaders = (): HeadersInit => {
  const headers = getDefaultHeaders();
  headers['Idempotency-Key'] = crypto.randomUUID();
  return headers;
};
```

### 3. ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº 401/403

**Ğ’ `src/utils/api.ts` Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿ĞµÑ€ĞµÑ…Ğ²Ğ°Ñ‚Ñ‡Ğ¸Ğº:**

```typescript
export const fetchWithRetry = async (
  url: string,
  options: RequestInit = {},
  retries = apiConfig.retry
): Promise<Response> => {
  try {
    const response = await fetch(url, options);

    // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° 401/403
    if (response.status === 401 || response.status === 403) {
      // ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ñ‚Ğ¾ĞºĞµĞ½
      localStorage.removeItem('session_token');
      localStorage.removeItem('user_context');
      
      // ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ auth-init
      if (window.Telegram?.WebApp?.initData) {
        const authResponse = await fetch('/webhook/auth-init', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            initData: window.Telegram.WebApp.initData
          })
        });

        const authData = await authResponse.json();
        if (authData.success) {
          localStorage.setItem('session_token', authData.data.session_token);
          // ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
          return fetchWithRetry(url, options, 0);
        }
      }
      
      throw new Error('Unauthorized');
    }

    return response;
  } catch (error) {
    if (retries > 0) {
      await new Promise(resolve => setTimeout(resolve, 1000));
      return fetchWithRetry(url, options, retries - 1);
    }
    throw error;
  }
};
```

### 4. ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¿Ñ€Ğ¾Ğ´Ğ»ĞµĞ½Ğ¸Ğµ ÑĞµÑÑĞ¸Ğ¸

**ĞĞ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾, Ğ² `src/App.tsx`:**

```typescript
useEffect(() => {
  // ĞŸÑ€Ğ¾Ğ´Ğ»ĞµĞ²Ğ°Ñ‚ÑŒ ÑĞµÑÑĞ¸Ñ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 4 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹
  const intervalId = setInterval(async () => {
    const token = localStorage.getItem('session_token');
    if (token) {
      try {
        await fetch('/webhook/auth-refresh', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
      } catch (error) {
        console.error('Session refresh failed:', error);
      }
    }
  }, 4 * 60 * 1000); // 4 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹

  return () => clearInterval(intervalId);
}, []);
```

### 5. Ğ£Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¿Ñ€ÑĞ¼Ğ¾Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ/Ñ‡Ğ°Ñ‚Ğ° Ğ¸Ğ· ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²

**Ğ’ `front/VoiceAssistantPage.tsx` â€” ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ:**

```typescript
// âŒ Ğ£Ğ”ĞĞ›Ğ˜Ğ¢Ğ¬
const handleCreateUser = async () => {
  // ... Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
};

// âŒ Ğ£Ğ”ĞĞ›Ğ˜Ğ¢Ğ¬
const handleCreateChat = async () => {
  // ... Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ñ‡Ğ°Ñ‚Ğ° Ñ‡ĞµÑ€ĞµĞ· createUser
};
```

**ĞÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾:**

```typescript
// âœ… ĞĞ¡Ğ¢ĞĞ’Ğ˜Ğ¢Ğ¬
const handleSendMessage = async (message: string) => {
  if (!currentChatId) {
    // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ‡Ğ°Ñ‚ Ñ‡ĞµÑ€ĞµĞ· API (ÑƒĞ¶Ğµ Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸ĞµĞ¹)
    const newChat = await createChat({ title: 'New Chat' });
    setCurrentChatId(newChat.id);
  }

  await saveMessage({
    chatId: currentChatId,
    role: 'user',
    content: message
  });

  // ... Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°
};
```

### 6. Ğ“Ğ²Ğ°Ñ€Ğ´Ñ‹ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ³Ğ²Ğ°Ñ€Ğ´Ğ°:**

```typescript
// src/components/AuthGuard.tsx
export const AuthGuard = ({ children }: { children: React.ReactNode }) => {
  const token = localStorage.getItem('session_token');
  const [isReady, setIsReady] = useState(false);

  useEffect(() => {
    if (!token && window.Telegram?.WebApp?.initData) {
      // Ğ’Ñ‹Ğ·Ğ²Ğ°Ñ‚ÑŒ auth-init
      initAuth().then(() => setIsReady(true));
    } else {
      setIsReady(true);
    }
  }, [token]);

  if (!isReady) {
    return <ModernSplashScreen />;
  }

  if (!token) {
    return <TelegramOnlyPage />;
  }

  return <>{children}</>;
};
```

**Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:**

```typescript
// src/App.tsx
<AuthGuard>
  <Routes>
    <Route path="/menu" element={<MenuPage />} />
    <Route path="/chat" element={<VoiceAssistantPage />} />
  </Routes>
</AuthGuard>
```

## ğŸ“… ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ğ½ (Ğ¿Ğ¾ÑˆĞ°Ğ³Ğ¾Ğ²Ğ¾)

### Ğ­Ñ‚Ğ°Ğ¿ 1: Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (1-2 Ğ´Ğ½Ñ)

**Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸:**
- [ ] Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ `YYYYMMDD_auth_system.sql`
- [ ] Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹: `companies`, `user_companies`, `sessions`
- [ ] ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ `users` (ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾), `chats`, `messages`
- [ ] Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹: `audit_events`, `idempotency_keys`, `rate_limits`
- [ ] Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ğ´ĞµĞºÑÑ‹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸
- [ ] ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ Ğ² Supabase
- [ ] Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ (1-2 ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸, Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ñ Ñ€Ğ¾Ğ»ÑĞ¼Ğ¸)

**Ğ¤Ğ°Ğ¹Ğ»Ñ‹:**
- `back/supabase/migrations/YYYYMMDD_auth_system.sql`

**SQL (ÑĞ¼. ÑĞµĞºÑ†Ğ¸Ñ "Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾")**

---

### Ğ­Ñ‚Ğ°Ğ¿ 2: n8n - Auth workflows (2-3 Ğ´Ğ½Ñ)

**Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸:**
- [ ] Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ subworkflow `auth.validate`
  - ĞŸÑ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ `token`
  - ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ ÑĞµÑÑĞ¸Ñ
  - ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ `last_seen_at`
  - ĞŸÑ€Ğ¾Ğ´Ğ»ĞµĞ²Ğ°ĞµÑ‚ `expires_at` (grace window)
  - Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ `context` Ğ¸Ğ»Ğ¸ `error`
- [ ] Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ webhook `/webhook/auth-init`
  - Function Node: Telegram initData validation (HMAC)
  - Postgres: Upsert user
  - Postgres: Get user company & role
  - Postgres: Create session
  - Response: `{ session_token, user, companyId, role }`
- [ ] Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ subworkflow `auth.refresh`
  - ĞŸÑ€Ğ¾Ğ´Ğ»ĞµĞ²Ğ°ĞµÑ‚ `expires_at`
- [ ] Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ subworkflow `auth.authorize` (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
  - RBAC Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
- [ ] Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ webhook `/webhook/auth-logout`
  - DELETE session

**Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:**
- ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ `auth-init` Ñ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¼ Telegram initData
- ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ `auth.validate` Ñ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¼/Ğ½ĞµĞ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¼ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ¼
- ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ´Ğ»ĞµĞ½Ğ¸Ğµ ÑĞµÑÑĞ¸Ğ¸

---

### Ğ­Ñ‚Ğ°Ğ¿ 3: n8n - ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… workflows (1-2 Ğ´Ğ½Ñ)

**Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸:**
- [ ] ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ `/webhook/chat.create`
  - Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Execute Workflow: `auth.validate`
  - Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ IF: Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ â†’ Response 401
  - Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ `context.userId`, `context.companyId` Ğ² INSERT
- [ ] ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ `/webhook/chat.get-history`
  - Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ `auth.validate`
  - Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾ `companyId` Ğ¸Ğ»Ğ¸ `userId`
- [ ] ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ `/webhook/chat.save-message`
  - Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ `auth.validate`
  - ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ñ‡Ğ°Ñ‚Ñƒ
  - Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¸Ğ´ĞµĞ¼Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
- [ ] ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ `/webhook/analytics.log-event`
  - Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ `auth.validate`
  - Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ `userId`/`companyId`

**ĞŸĞ°Ñ‚Ñ‚ĞµÑ€Ğ½ Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ²Ğ¾Ñ€ĞºÑ„Ğ»Ğ¾Ñƒ:**
```
Webhook â†’ Execute: auth.validate â†’ IF (error) â†’ Response 401/403
                                  â†’ ELSE â†’ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° â†’ Response
```

---

### Ğ­Ñ‚Ğ°Ğ¿ 4: Ğ¤Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´ - Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ (1-2 Ğ´Ğ½Ñ)

**Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸:**
- [ ] ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ `src/App.tsx`
  - Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ `initAuth()` Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ğµ
  - Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑŒ `session_token` Ğ² `localStorage`
- [ ] ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ `src/utils/api.ts`
  - Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ `Authorization: Bearer <token>` Ğ² `getDefaultHeaders()`
  - Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºÑƒ 401/403 â†’ re-auth
  - Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ `getIdempotentHeaders()` Ğ´Ğ»Ñ mutating-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
- [ ] Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ `src/components/AuthGuard.tsx`
  - ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑÑ‚ÑŒ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ñ‚Ğ¾ĞºĞµĞ½Ğ°
  - ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ splash/TelegramOnlyPage Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğ¸
- [ ] ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ `front/VoiceAssistantPage.tsx`
  - Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¿Ñ€ÑĞ¼Ğ¾Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ/Ñ‡Ğ°Ñ‚Ğ°
  - Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ API calls (`createChat`, `saveMessage`, `getChatHistory`)
- [ ] Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ğ¿Ñ€Ğ¾Ğ´Ğ»ĞµĞ½Ğ¸Ğµ ÑĞµÑÑĞ¸Ğ¸ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
  - Ğ˜Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ» 4 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹ â†’ Ğ²Ñ‹Ğ·Ğ¾Ğ² `/webhook/auth-refresh`

**Ğ¤Ğ°Ğ¹Ğ»Ñ‹:**
- `src/App.tsx`
- `src/utils/api.ts`
- `src/components/AuthGuard.tsx`
- `front/VoiceAssistantPage.tsx`

---

### Ğ­Ñ‚Ğ°Ğ¿ 5: Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ñ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾, 1-2 Ğ´Ğ½Ñ)

**Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸:**
- [ ] Ğ˜Ğ´ĞµĞ¼Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ
  - Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ `Idempotency-Key` Ğ² `/webhook/chat.save-message`
  - Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑŒ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ² `idempotency_keys`
- [ ] Rate Limiting
  - Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ Ğ² Ğ¼ÑƒÑ‚Ğ¸Ñ€ÑƒÑÑ‰Ğ¸Ñ… ÑĞ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚Ğ°Ñ…
  - Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒ 429 Ğ¿Ñ€Ğ¸ Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞµĞ½Ğ¸Ğ¸ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ°
- [ ] Audit logging
  - Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ²ÑĞµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ² `audit_events`
- [ ] Switch Company
  - Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ `/webhook/auth-switch-company`
  - ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ `sessions.active_company_id`
- [ ] Cron jobs (Schedule Triggers)
  - Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ñ… ÑĞµÑÑĞ¸Ğ¹ (Ñ€Ğ°Ğ· Ğ² Ñ‡Ğ°Ñ)
  - Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ€Ñ‹Ñ… idempotency_keys (Ñ€Ğ°Ğ· Ğ² Ğ´ĞµĞ½ÑŒ)
  - Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ€Ñ‹Ñ… rate_limits (Ñ€Ğ°Ğ· Ğ² Ñ‡Ğ°Ñ)

---

### Ğ­Ñ‚Ğ°Ğ¿ 6: Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ (1 Ğ´ĞµĞ½ÑŒ)

**Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸:**
- [ ] Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ğ¾Ğµ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ (ÑĞ¼. Ñ‚ĞµÑÑ‚-Ğ¿Ğ»Ğ°Ğ½ Ğ½Ğ¸Ğ¶Ğµ)
- [ ] ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ `back/README.md` Ñ Ğ½Ğ¾Ğ²Ñ‹Ğ¼Ğ¸ ÑĞ½Ğ´Ğ¿Ğ¾Ğ¹Ğ½Ñ‚Ğ°Ğ¼Ğ¸
- [ ] Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹ curl-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ API
- [ ] Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ²ÑĞµ n8n Ğ²Ğ¾Ñ€ĞºÑ„Ğ»Ğ¾Ñƒ (Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ²Ñ…Ğ¾Ğ´Ñ‹/Ğ²Ñ‹Ñ…Ğ¾Ğ´Ñ‹)

---

## âœ… Ğ¢ĞµÑÑ‚-Ğ¿Ğ»Ğ°Ğ½ (Ñ‡ĞµĞº-Ğ»Ğ¸ÑÑ‚)

### ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
- [ ] **auth-init (Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ)**: ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ÑÑ user, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ `session_token`, Ñ€Ğ¾Ğ»ÑŒ `null` (Ğ½ĞµÑ‚ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸)
- [ ] **auth-init (ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ)**: Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ÑÑ user, ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ÑÑ Ğ½Ğ¾Ğ²Ğ°Ñ ÑĞµÑÑĞ¸Ñ, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ Ñ€Ğ¾Ğ»ÑŒ Ğ¸Ğ· `user_companies`
- [ ] **auth-init (Ğ½ĞµĞ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¹ initData)**: Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ 401 Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¾Ğ¹ HMAC
- [ ] **auth.validate (Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¹ Ñ‚Ğ¾ĞºĞµĞ½)**: Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ context Ñ userId, role, companyId
- [ ] **auth.validate (Ğ½ĞµĞ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¹ Ñ‚Ğ¾ĞºĞµĞ½)**: Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ 401
- [ ] **auth.validate (Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ğ°Ñ ÑĞµÑÑĞ¸Ñ)**: Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ 401
- [ ] **auth.refresh**: `expires_at` Ğ¿Ñ€Ğ¾Ğ´Ğ»ĞµĞ²Ğ°ĞµÑ‚ÑÑ, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ Ğ½Ğ¾Ğ²Ğ°Ñ Ğ´Ğ°Ñ‚Ğ°
- [ ] **auth-logout**: ÑĞµÑÑĞ¸Ñ ÑƒĞ´Ğ°Ğ»ÑĞµÑ‚ÑÑ, Ğ¿Ğ¾ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ñ ÑÑ‚Ğ¸Ğ¼ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ¼ â†’ 401

### Ğ§Ğ°Ñ‚Ñ‹
- [ ] **chat.create (Ğ±ĞµĞ· Ñ‚Ğ¾ĞºĞµĞ½Ğ°)**: â†’ 401
- [ ] **chat.create (Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ¼)**: ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ÑÑ Ñ‡Ğ°Ñ‚ Ñ `company_id = context.companyId`, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ chat object
- [ ] **chat.getHistory (ÑĞ²Ğ¾Ğ¹ Ñ‡Ğ°Ñ‚)**: Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ ÑĞ¿Ğ¸ÑĞ¾Ğº ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
- [ ] **chat.getHistory (Ñ‡ÑƒĞ¶Ğ¾Ğ¹ Ñ‡Ğ°Ñ‚, Ğ´Ñ€ÑƒĞ³Ğ°Ñ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ)**: â†’ 403 Ğ¸Ğ»Ğ¸ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº
- [ ] **chat.saveMessage (Ñ Idempotency-Key)**: ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ÑÑ
- [ ] **chat.saveMessage (Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ğ¹ Ñ Ñ‚ĞµĞ¼ Ğ¶Ğµ Idempotency-Key)**: Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚, Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚ Ğ½Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ÑÑ

### Ğ Ğ¾Ğ»Ğ¸ Ğ¸ RBAC
- [ ] **owner Ğ²Ğ¸Ğ´Ğ¸Ñ‚ Ğ²ÑĞµ Ñ‡Ğ°Ñ‚Ñ‹ ÑĞ²Ğ¾ĞµĞ¹ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸**: Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ `company_id` Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚
- [ ] **manager Ğ²Ğ¸Ğ´Ğ¸Ñ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡Ğ°Ñ‚Ñ‹ ÑĞ²Ğ¾ĞµĞ¹ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸**: Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ `company_id` Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚
- [ ] **manager ĞĞ• Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ñ‡Ğ°Ñ‚**: â†’ 403
- [ ] **owner Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ñ‡Ğ°Ñ‚**: Ñ‡Ğ°Ñ‚ ÑƒĞ´Ğ°Ğ»ÑĞµÑ‚ÑÑ

### Rate Limiting
- [ ] **Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞµĞ½ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ (31-Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ·Ğ° Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ)**: â†’ 429 Too Many Requests
- [ ] **Ğ² Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ¼Ğ¸Ğ½ÑƒÑ‚Ğµ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸Ğº ÑĞ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµÑ‚ÑÑ**: Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¿Ñ€Ğ¾Ñ…Ğ¾Ğ´ÑÑ‚

### Ğ˜Ğ´ĞµĞ¼Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ
- [ ] **Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ğ¹ POST Ñ Ñ‚ĞµĞ¼ Ğ¶Ğµ Idempotency-Key**: Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚, Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ½Ğµ Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ
- [ ] **POST Ñ Ğ½Ğ¾Ğ²Ñ‹Ğ¼ Idempotency-Key**: ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ÑÑ Ğ½Ğ¾Ğ²Ğ°Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ

### ĞÑƒĞ´Ğ¸Ñ‚
- [ ] **Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ğ² audit_events**: login, chat.create, message.save

## ğŸ“š ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ

### A. ĞšĞ¾Ğ´ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Telegram initData (Ğ´Ğ»Ñ Function Node Ğ² n8n)

```javascript
// Function Node Ğ² Ğ²Ğ¾Ñ€ĞºÑ„Ğ»Ğ¾Ñƒ auth-init
const crypto = require('crypto');

const BOT_TOKEN = 'YOUR_BOT_TOKEN'; // Ğ¸Ğ· env Ğ¸Ğ»Ğ¸ n8n credentials

function verifyTelegramInitData(initData) {
  try {
    // 1. ĞŸĞ°Ñ€ÑĞ¸Ğ¼ initData
    const params = new URLSearchParams(initData);
    const hash = params.get('hash');
    params.delete('hash');
    
    if (!hash) {
      return { valid: false, error: 'Missing hash' };
    }
    
    // 2. Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ»ÑÑ‡Ğ¸ Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ data-check-string
    const dataCheckArr = [];
    for (const [key, value] of params.entries()) {
      dataCheckArr.push(`${key}=${value}`);
    }
    dataCheckArr.sort();
    const dataCheckString = dataCheckArr.join('\n');
    
    // 3. Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ secret_key = HMAC_SHA256("WebAppData", BOT_TOKEN)
    const secretKey = crypto
      .createHmac('sha256', 'WebAppData')
      .update(BOT_TOKEN)
      .digest();
    
    // 4. Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ data_hash = HMAC_SHA256(secret_key, data_check_string)
    const dataHash = crypto
      .createHmac('sha256', secretKey)
      .update(dataCheckString)
      .digest('hex');
    
    // 5. Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°ĞµĞ¼
    if (dataHash !== hash) {
      return { valid: false, error: 'Invalid hash' };
    }
    
    // 6. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ auth_date (Ğ½Ğµ ÑÑ‚Ğ°Ñ€ÑˆĞµ 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚)
    const authDate = parseInt(params.get('auth_date'));
    const now = Math.floor(Date.now() / 1000);
    if (now - authDate > 300) { // 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
      return { valid: false, error: 'Auth date too old' };
    }
    
    // 7. Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ user
    const userStr = params.get('user');
    if (!userStr) {
      return { valid: false, error: 'Missing user data' };
    }
    
    const user = JSON.parse(userStr);
    
    return {
      valid: true,
      user: {
        id: user.id,
        username: user.username || null,
        first_name: user.first_name || null,
        last_name: user.last_name || null,
        language_code: user.language_code || 'ru'
      }
    };
  } catch (error) {
    return { valid: false, error: error.message };
  }
}

// Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ² n8n
const initData = $json.initData; // Ğ¸Ğ· webhook body
const result = verifyTelegramInitData(initData);

if (!result.valid) {
  // Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ 401
  return {
    json: {
      error: 'unauthorized',
      status: 401,
      message: result.error,
      traceId: $json.traceId || crypto.randomUUID()
    }
  };
}

// ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‚ÑŒ user Ğ´Ğ°Ğ»ÑŒÑˆĞµ
return { json: { user: result.user } };
```

---

### B. ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹ curl-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

#### 1. Auth Init
```bash
curl -X POST https://your-domain.com/webhook/auth-init \
  -H "Content-Type: application/json" \
  -d '{
    "initData": "query_id=AAHdF6IQAAAAAN0XohDhrOrc&user=%7B%22id%22%3A279058397%2C%22first_name%22%3A%22John%22%2C%22last_name%22%3A%22Doe%22%2C%22username%22%3A%22johndoe%22%2C%22language_code%22%3A%22en%22%7D&auth_date=1699000000&hash=abc123...",
    "appVersion": "1.0.0"
  }'
```

**ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚:**
```json
{
  "success": true,
  "data": {
    "session_token": "550e8400-e29b-41d4-a716-446655440000",
    "user": {
      "id": "123e4567-e89b-12d3-a456-426614174000",
      "telegram_id": 279058397,
      "username": "johndoe",
      "first_name": "John",
      "last_name": "Doe"
    },
    "companyId": "c0e4567-e89b-12d3-a456-426614174999",
    "role": "owner"
  },
  "traceId": "..."
}
```

#### 2. Create Chat
```bash
TOKEN="550e8400-e29b-41d4-a716-446655440000"

curl -X POST https://your-domain.com/webhook/chat.create \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "title": "My First Chat"
  }'
```

#### 3. Get Chat History
```bash
curl -X POST https://your-domain.com/webhook/chat.get-history \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "chatId": "abc-123-chat-id"
  }'
```

#### 4. Save Message (Ñ Ğ¸Ğ´ĞµĞ¼Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒÑ)
```bash
IDEMPOTENCY_KEY=$(uuidgen)

curl -X POST https://your-domain.com/webhook/chat.save-message \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Idempotency-Key: $IDEMPOTENCY_KEY" \
  -d '{
    "chatId": "abc-123-chat-id",
    "role": "user",
    "content": "Hello, AI!"
  }'
```

#### 5. Logout
```bash
curl -X POST https://your-domain.com/webhook/auth-logout \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN"
```

---

### C. ĞšĞ¾Ğ½Ğ²ĞµĞ½Ñ†Ğ¸Ğ¸ Ğ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ n8n Ğ²Ğ¾Ñ€ĞºÑ„Ğ»Ğ¾Ñƒ

**Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµĞ¼Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°:**

```
/auth
  â”œâ”€â”€ init (webhook)
  â”œâ”€â”€ validate (subworkflow)
  â”œâ”€â”€ refresh (subworkflow)
  â”œâ”€â”€ authorize (subworkflow)
  â””â”€â”€ logout (webhook)

/chat
  â”œâ”€â”€ create (webhook)
  â”œâ”€â”€ get-history (webhook)
  â”œâ”€â”€ save-message (webhook)
  â””â”€â”€ delete (webhook, Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ owner)

/analytics
  â””â”€â”€ log-event (webhook)

/admin (Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞµ)
  â”œâ”€â”€ list-users (webhook)
  â””â”€â”€ assign-role (webhook)
```

**ĞŸÑ€ĞµÑ„Ğ¸ĞºÑÑ‹:**
- Webhook: `/webhook/auth-init`, `/webhook/chat.create`
- Subworkflow: `auth.validate`, `chat.authorize`

---

### D. Environment Variables (Ğ´Ğ»Ñ n8n)

**Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² `.env` Ğ¸Ğ»Ğ¸ n8n credentials:**

```env
# Telegram
TELEGRAM_BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz

# Database (ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ Ğ² Supabase)
DB_HOST=db.xxx.supabase.co
DB_PORT=5432
DB_NAME=postgres
DB_USER=postgres
DB_PASSWORD=your-password

# Sessions
SESSION_LIFETIME_DAYS=7
SESSION_GRACE_MINUTES=5

# Rate Limits
RATE_LIMIT_MESSAGES_PER_MINUTE=30
RATE_LIMIT_EVENTS_PER_MINUTE=100

# Features
ENABLE_IDEMPOTENCY=true
ENABLE_RATE_LIMITING=true
ENABLE_AUDIT_LOGGING=true
```

---

### E. ĞŸĞ¾Ğ»Ğ½Ğ°Ñ SQL Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ

**Ğ¤Ğ°Ğ¹Ğ»:** `back/supabase/migrations/20251104_auth_system.sql`

```sql
-- ============================================
-- Auth System Migration
-- Ğ”Ğ°Ñ‚Ğ°: 2025-11-04
-- ============================================

-- 1. Companies
CREATE TABLE IF NOT EXISTS companies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  settings JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 2. User Companies (Ñ€Ğ¾Ğ»Ğ¸)
CREATE TABLE IF NOT EXISTS user_companies (
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
  role TEXT NOT NULL CHECK (role IN ('owner', 'manager', 'viewer')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  PRIMARY KEY (user_id, company_id)
);

CREATE INDEX idx_user_companies_user ON user_companies(user_id);
CREATE INDEX idx_user_companies_company ON user_companies(company_id);

-- 3. Sessions
CREATE TABLE IF NOT EXISTS sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  expires_at TIMESTAMPTZ NOT NULL,
  last_seen_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  user_agent TEXT,
  ip TEXT,
  active_company_id UUID REFERENCES companies(id) ON DELETE SET NULL
);

CREATE INDEX idx_sessions_user ON sessions(user_id);
CREATE INDEX idx_sessions_expires ON sessions(expires_at);

-- 4. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ chats (Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ company_id ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚)
ALTER TABLE chats ADD COLUMN IF NOT EXISTS company_id UUID REFERENCES companies(id) ON DELETE SET NULL;

CREATE INDEX IF NOT EXISTS idx_chats_company ON chats(company_id);

-- 5. Audit Events (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
CREATE TABLE IF NOT EXISTS audit_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE SET NULL,
  company_id UUID REFERENCES companies(id) ON DELETE SET NULL,
  action TEXT NOT NULL,
  resource TEXT,
  resource_id UUID,
  meta JSONB DEFAULT '{}',
  ip TEXT,
  user_agent TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_audit_user ON audit_events(user_id);
CREATE INDEX idx_audit_company ON audit_events(company_id);
CREATE INDEX idx_audit_created ON audit_events(created_at DESC);
CREATE INDEX idx_audit_action ON audit_events(action);

-- 6. Idempotency Keys (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
CREATE TABLE IF NOT EXISTS idempotency_keys (
  key UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  endpoint TEXT NOT NULL,
  response JSONB NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_idempotency_created ON idempotency_keys(created_at);

-- 7. Rate Limits (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
CREATE TABLE IF NOT EXISTS rate_limits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  company_id UUID REFERENCES companies(id) ON DELETE CASCADE,
  endpoint TEXT NOT NULL,
  minute_bucket TIMESTAMPTZ NOT NULL,
  count INTEGER DEFAULT 1,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE (user_id, endpoint, minute_bucket)
);

CREATE INDEX idx_rate_limits_bucket ON rate_limits(minute_bucket);

-- 8. Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
-- INSERT INTO companies (id, name) VALUES 
--   ('c0e4567-e89b-12d3-a456-426614174999', 'Test Company A'),
--   ('c0e4567-e89b-12d3-a456-426614175000', 'Test Company B');
```

---

## ğŸ¯ Ğ˜Ñ‚Ğ¾Ğ³Ğ¸ Ğ¸ Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ñ‹

### Ğ§Ñ‚Ğ¾ Ğ¼Ñ‹ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼

âœ… **Ğ•Ğ´Ğ¸Ğ½Ğ°Ñ Ñ‚Ğ¾Ñ‡ĞºĞ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸**: Ğ²ÑĞµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¿Ñ€Ğ¾Ñ…Ğ¾Ğ´ÑÑ‚ Ñ‡ĞµÑ€ĞµĞ· `auth.validate`  
âœ… **RBAC**: Ñ€Ğ¾Ğ»Ğ¸ (owner, manager, viewer) Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ñ€Ğ°Ğ² Ğ½Ğ° Ñ€ĞµÑÑƒÑ€ÑÑ‹  
âœ… **Ğ˜Ğ·Ğ¾Ğ»ÑÑ†Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…**: ĞºĞ°Ğ¶Ğ´Ğ°Ñ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ Ğ²Ğ¸Ğ´Ğ¸Ñ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ²Ğ¾Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ  
âœ… **Ğ¡ĞµÑÑĞ¸Ğ¸ Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¿Ñ€Ğ¾Ğ´Ğ»ĞµĞ½Ğ¸ĞµĞ¼**: grace window + ÑĞºĞ¾Ğ»ÑŒĞ·ÑÑ‰ĞµĞµ Ğ¾ĞºĞ½Ğ¾  
âœ… **Ğ•Ğ´Ğ¸Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ API**: Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ¸ ÑƒÑĞ¿ĞµÑˆĞ½Ñ‹Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹ Ğ² ĞµĞ´Ğ¸Ğ½Ğ¾Ğ¼ ÑÑ‚Ğ¸Ğ»Ğµ  
âœ… **Ğ˜Ğ´ĞµĞ¼Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ**: Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²  
âœ… **Rate Limiting**: Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ ÑĞ¿Ğ°Ğ¼Ğ°  
âœ… **Audit Log**: Ğ¿Ğ¾Ğ»Ğ½Ğ°Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹  

### ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ñ‹ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸

1. **ĞŸÑ€Ğ¾ÑÑ‚Ğ¾Ñ‚Ğ° Ğ²Ğ°Ğ¶Ğ½ĞµĞµ**: Ğ±ĞµĞ· JWT, Ğ±ĞµĞ· ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ñ… ÑÑ…ĞµĞ¼ â€” UUID-Ñ‚Ğ¾ĞºĞµĞ½ Ğ² Ğ‘Ğ”
2. **KISS**: Ğ¾Ğ´Ğ½Ğ° Ñ‚Ğ¾Ñ‡ĞºĞ° Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ (`auth.validate`), ĞµĞ´Ğ¸Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ²Ğ¾Ñ€ĞºÑ„Ğ»Ğ¾Ñƒ
3. **Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ**: HMAC-Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Telegram initData, Ğ¸Ğ·Ğ¾Ğ»ÑÑ†Ğ¸Ñ Ğ¿Ğ¾ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸ÑĞ¼
4. **Ğ Ğ°ÑÑˆĞ¸Ñ€ÑĞµĞ¼Ğ¾ÑÑ‚ÑŒ**: Ğ»ĞµĞ³ĞºĞ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ñ€Ğ¾Ğ»Ğ¸, Ñ€ĞµÑÑƒÑ€ÑÑ‹, ÑĞ½Ğ´Ğ¿Ğ¾Ğ¹Ğ½Ñ‚Ñ‹
5. **ĞĞ°Ğ±Ğ»ÑĞ´Ğ°ĞµĞ¼Ğ¾ÑÑ‚ÑŒ**: traceId, audit_events, Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

### Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑˆĞ°Ğ³Ğ¸

1. ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ñ **Ğ­Ñ‚Ğ°Ğ¿Ğ° 1** (Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…)
2. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ **auth.validate** Ğ¸ **auth-init** (Ğ­Ñ‚Ğ°Ğ¿ 2)
3. ĞŸÑ€Ğ¾Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾
4. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ Ğ²Ğ¾Ñ€ĞºÑ„Ğ»Ğ¾Ñƒ (Ğ­Ñ‚Ğ°Ğ¿ 3)
5. Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ğ¾Ğ¼ (Ğ­Ñ‚Ğ°Ğ¿ 4)
6. Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ñ (Ğ­Ñ‚Ğ°Ğ¿ 5)

---

**Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ğ³Ğ¾Ñ‚Ğ¾Ğ² Ğº Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ĞºĞ°Ğº Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾ Ğ²Ğ½ĞµĞ´Ñ€ĞµĞ½Ğ¸Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸.**

