# üóÑÔ∏è Lumon Database

–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Lumon Platform –Ω–∞ Supabase (PostgreSQL)

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
base/supabase/
‚îú‚îÄ‚îÄ migrations/           # SQL –º–∏–≥—Ä–∞—Ü–∏–∏
‚îÇ   ‚îî‚îÄ‚îÄ 001_initial_schema.sql
‚îú‚îÄ‚îÄ config.toml          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supabase
‚îî‚îÄ‚îÄ README.md
```

## üóÑÔ∏è –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü—ã

1. **users** - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ Telegram
   - `telegram_id` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∏–∑ Telegram
   - –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ

2. **chats** - –°–µ—Å—Å–∏–∏ —á–∞—Ç–æ–≤
   - –°–≤—è–∑–∞–Ω–∞ —Å `users`
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 14 –¥–Ω–µ–π (`expires_at`)

3. **messages** - –°–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–æ–≤
   - –°–≤—è–∑–∞–Ω–∞ —Å `chats`
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–æ–ª–µ–π: user, assistant, system
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–ª–æ–∂–µ–Ω–∏–π (JSONB)

4. **documents** - –î–æ–∫—É–º–µ–Ω—Ç—ã –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
   - –°–≤—è–∑–∞–Ω–∞ —Å `users`
   - –°—Ç–∞—Ç—É—Å—ã: processing, processed, error
   - –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ JSONB

5. **analytics_events** - –°–æ–±—ã—Ç–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
   - –°–≤—è–∑–∞–Ω–∞ —Å `users`
   - –ì–∏–±–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —á–µ—Ä–µ–∑ JSONB

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏–∏

–ú–∏–≥—Ä–∞—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ —á–µ—Ä–µ–∑ Docker Compose.

–î–ª—è —Ä—É—á–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:

```bash
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
docker exec -it lumon-supabase-db psql -U postgres -d lumon

# –ò–ª–∏ —á–µ—Ä–µ–∑ Supabase Studio
# http://localhost:3001 -> SQL Editor
```

## üîç –ò–Ω–¥–µ–∫—Å—ã

–í—Å–µ —Ç–∞–±–ª–∏—Ü—ã –∏–º–µ—é—Ç –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤:
- `users.telegram_id` - –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ Telegram ID
- `chats.user_id` - –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —á–∞—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `chats.expires_at` - –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö —á–∞—Ç–æ–≤
- `messages.chat_id` - –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞
- –ò –¥—Ä—É–≥–∏–µ...

## ‚è∞ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

–¢–∞–±–ª–∏—Ü—ã `users`, `chats`, `documents` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç –ø–æ–ª–µ `updated_at` –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä—ã PostgreSQL.

## üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–ß–∞—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ 14 –¥–Ω–µ–π (`expires_at`).

–î–ª—è —Ä—É—á–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏:

```sql
-- –£–¥–∞–ª–µ–Ω–∏–µ –∏—Å—Ç–µ–∫—à–∏—Ö —á–∞—Ç–æ–≤
DELETE FROM chats WHERE expires_at < NOW();
```

–ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å cron –∑–∞–¥–∞—á—É –≤ n8n –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏.

