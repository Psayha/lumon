name: Deploy to Server (SSH)

on:
  push:
    branches:
      - main
      - claude/n8n-nextjs-integration-011CUzUwzaJL8RuKyUxZTE1m
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build
        env:
          VITE_API_URL: ''

      - name: Build admin panel
        run: |
          # –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–±—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑ –∫–æ—Ä–Ω—è
          npx vite build --config adminpage/vite.config.ts
        env:
          VITE_API_URL: ''

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p "$SSH_PORT" "$SSH_HOST" >> ~/.ssh/known_hosts
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_KEY: ${{ secrets.SSH_KEY }}

      - name: Ensure remote deploy directory exists
        run: |
          ssh -i ~/.ssh/deploy_key -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" "mkdir -p $DEPLOY_PATH"
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}

      - name: Calculate backend path
        id: backend_path
        run: |
          DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
          BACKEND_PATH=$(dirname "$DEPLOY_PATH")/back
          echo "path=$BACKEND_PATH" >> $GITHUB_OUTPUT
          echo "Backend path will be: $BACKEND_PATH"

      - name: Prepare backend migrations
        run: |
          mkdir -p back/supabase/migrations
          cp -r base/supabase/migrations/* back/supabase/migrations/ || true

      - name: Deploy frontend via rsync
        run: |
          rsync -avz --delete -e "ssh -i ~/.ssh/deploy_key -p $SSH_PORT" dist/ "$SSH_USER@$SSH_HOST:$DEPLOY_PATH"
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}

      - name: Deploy admin panel via rsync
        run: |
          ssh -i ~/.ssh/deploy_key -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" "mkdir -p /var/www/lumon2/dist-admin"
          rsync -avz --delete -e "ssh -i ~/.ssh/deploy_key -p $SSH_PORT" dist-admin/ "$SSH_USER@$SSH_HOST:/var/www/lumon2/dist-admin/"
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USER: ${{ secrets.SSH_USER }}

      - name: Ensure remote backend directory exists
        run: |
          ssh -i ~/.ssh/deploy_key -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" "mkdir -p ${{ steps.backend_path.outputs.path }}"
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USER: ${{ secrets.SSH_USER }}

      - name: Deploy backend via rsync
        run: |
          rsync -avz --delete -e "ssh -i ~/.ssh/deploy_key -p $SSH_PORT" back/ "$SSH_USER@$SSH_HOST:${{ steps.backend_path.outputs.path }}"
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USER: ${{ secrets.SSH_USER }}

      - name: Setup .env file on server
        run: |
          ssh -i ~/.ssh/deploy_key -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" "cd ${{ steps.backend_path.outputs.path }} && if [ -f .env.production ]; then cp .env.production .env; elif [ ! -f .env ]; then cp env.example .env; fi && echo 'N8N_SECURE_COOKIE=false' >> .env && sort -u .env -o .env"
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USER: ${{ secrets.SSH_USER }}

      - name: Deploy backend services with Docker Compose
        run: |
          ssh -i ~/.ssh/deploy_key -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" "cd ${{ steps.backend_path.outputs.path }} && docker compose up -d --build"
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USER: ${{ secrets.SSH_USER }}

      - name: Wait for n8n to be ready
        run: |
          echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ n8n (30 —Å–µ–∫—É–Ω–¥)..."
          sleep 30
          ssh -i ~/.ssh/deploy_key -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" "curl -f http://localhost:5678/healthz || echo 'n8n –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤'"
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USER: ${{ secrets.SSH_USER }}

      - name: Import n8n workflows (optional)
        continue-on-error: true
        run: |
          ssh -i ~/.ssh/deploy_key -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" "cd ${{ steps.backend_path.outputs.path }} && chmod +x import-workflows.sh && ./import-workflows.sh http://localhost:5678 || echo '‚ö†Ô∏è –ò–º–ø–æ—Ä—Ç workflows –ø—Ä–æ–ø—É—â–µ–Ω (–º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤—Ä—É—á–Ω—É—é)'"
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USER: ${{ secrets.SSH_USER }}

      - name: Smoke tests - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –¥–æ–º–µ–Ω–æ–≤
        run: |
          echo "üß™ –ó–∞–ø—É—Å–∫ smoke-—Ç–µ—Å—Ç–æ–≤..."
          
          DOMAINS=(
            "https://psayha.ru"
            "https://n8n.psayha.ru"
            "https://sb.psayha.ru"
            "https://admin.psayha.ru"
          )
          
          FAILED=0
          
          for DOMAIN in "${DOMAINS[@]}"; do
            echo ""
            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ $DOMAIN..."
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$DOMAIN" || echo "000")
            
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ] || [ "$HTTP_CODE" = "307" ] || [ "$HTTP_CODE" = "403" ]; then
              echo "‚úÖ $DOMAIN - OK (HTTP $HTTP_CODE)"
            else
              echo "‚ùå $DOMAIN - FAILED (HTTP $HTTP_CODE)"
              FAILED=$((FAILED + 1))
            fi
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
            SSL_CHECK=$(curl -s -o /dev/null -w "%{ssl_verify_result}" --max-time 10 "$DOMAIN" || echo "1")
            if [ "$SSL_CHECK" = "0" ]; then
              echo "   ‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤–∞–ª–∏–¥–µ–Ω"
            else
              echo "   ‚ö†Ô∏è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç: –∫–æ–¥ $SSL_CHECK"
            fi
          done
          
          echo ""
          if [ $FAILED -eq 0 ]; then
            echo "‚úÖ –í—Å–µ smoke-—Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã!"
          else
            echo "‚ùå –ü—Ä–æ–≤–∞–ª–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤: $FAILED"
            exit 1
          fi
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USER: ${{ secrets.SSH_USER }}

